# Tennis Ball Spin WebApp - 产品需求文档 (PRD)

## 1. 项目概述

- **项目名称**：Tennis Ball Spin WebApp（网球旋转无线仪表盘）
- **目标**：将 M5Stack ATOM S3 的 IMU 数据通过 WiFi 实时推送到浏览器，实现大屏可视化分析，让教练和球员能够在手机或电脑上直观地观察网球旋转状态、转速及运动轨迹数据。
- **核心方案**：ESP32-S3 WiFi AP 模式 + WebSocket 实时通信 + 纯前端 Canvas 渲染
- **适用场景**：网球训练场地、室内击球分析、旋转教学演示

---

## 2. 系统架构

整个系统采用 ATOM S3 作为独立 WiFi 热点，无需依赖外部路由器，手机或电脑直接连接即可使用。

```
ATOM S3 (WiFi AP: "TennisBall_IMU")
    ├── HTTP Server (port 80) → 提供嵌入式网页（HTML/CSS/JS 全部存储在固件中）
    └── WebSocket Server (port 81) → 推送 IMU 数据 (50Hz JSON)
         │
    手机/电脑浏览器连接 WiFi → 打开 192.168.4.1
         │
    网页接收 WebSocket 数据 → Canvas 实时渲染
```

**数据流说明**：

1. ATOM S3 以 50Hz 频率读取 MPU6886 陀螺仪和加速度计原始数据
2. 固件内部进行四元数积分，计算当前姿态和转速（RPM）
3. 数据打包为 JSON 格式，通过 WebSocket 推送到所有已连接的浏览器客户端
4. 浏览器前端解析 JSON，驱动 3D 网球渲染、实时曲线图表和数值显示
5. 用户可在浏览器端录制数据并导出为 CSV 文件，也可发送命令重置四元数

---

## 3. 硬件规格

| 项目 | 规格 |
|------|------|
| 主控模块 | M5Stack ATOM S3 |
| 处理器 | ESP32-S3，双核 Xtensa LX7，主频 240MHz |
| IMU 传感器 | MPU6886（6 轴：3 轴加速度计 + 3 轴陀螺仪） |
| 屏幕 | 128x128 彩色 LCD |
| WiFi | 802.11 b/g/n，2.4GHz，支持 AP 模式 |
| 按键 | 正面 BtnA（可编程按键） |
| 供电 | USB-C 或锂电池 |

**ATOM S3 屏幕显示内容**：

- WiFi SSID 名称
- 设备 IP 地址（192.168.4.1）
- 当前已连接客户端数量
- 实时 RPM 转速数值

---

## 4. 固件功能

### 4.1 WiFi AP 模式

- SSID：`TennisBall_IMU`
- 密码：`tennis123`
- IP 地址：`192.168.4.1`（ESP32 AP 模式默认网关）
- 最大同时连接设备数：4 台（WiFi 层面）

### 4.2 HTTP 服务器

- 监听端口：80
- 提供完整的网页仪表盘（HTML + CSS + JavaScript）
- 网页代码以 PROGMEM raw string literal 形式嵌入固件，无需外部文件系统
- 访问 `http://192.168.4.1/` 即可加载完整仪表盘页面

### 4.3 WebSocket 服务器

- 监听端口：81
- 推送频率：50Hz（每 20ms 一包）
- 数据格式：JSON（详见第 5 节数据协议）
- 支持接收客户端命令（如重置四元数）
- 最大同时 WebSocket 客户端数：3

### 4.4 IMU 数据处理

- 陀螺仪读取：X/Y/Z 三轴角速度（单位：°/s）
- 加速度计读取：X/Y/Z 三轴加速度（单位：g）
- 四元数积分：基于陀螺仪数据实时积分计算姿态四元数
- RPM 计算：由角速度合成向量计算转速（转/分钟）

### 4.5 ATOM S3 屏幕显示

利用 128x128 彩色 LCD 显示关键运行状态：

- 第一行：WiFi SSID（`TennisBall_IMU`）
- 第二行：IP 地址（`192.168.4.1`）
- 第三行：已连接客户端数量（如 `Clients: 2`）
- 第四行：当前实时 RPM（如 `1250 RPM`）

### 4.6 按键功能

- **BtnA 短按**：重置四元数为初始状态（单位四元数 [1, 0, 0, 0]），将当前姿态归零

---

## 5. 数据协议

### 5.1 WebSocket 推送数据（服务器 → 客户端）

JSON 格式，每 20ms 推送一包：

```json
{
  "t": 12345,
  "ax": 0.01,
  "ay": 0.02,
  "az": 1.00,
  "gx": 120.5,
  "gy": -45.2,
  "gz": 890.1,
  "qw": 0.99,
  "qx": 0.01,
  "qy": 0.02,
  "qz": 0.03,
  "rpm": 150
}
```

**字段说明**：

| 字段 | 类型 | 单位 | 说明 |
|------|------|------|------|
| `t` | int | ms | 设备启动以来的时间戳（millis） |
| `ax` | float | g | 加速度计 X 轴 |
| `ay` | float | g | 加速度计 Y 轴 |
| `az` | float | g | 加速度计 Z 轴 |
| `gx` | float | °/s | 陀螺仪 X 轴角速度 |
| `gy` | float | °/s | 陀螺仪 Y 轴角速度 |
| `gz` | float | °/s | 陀螺仪 Z 轴角速度 |
| `qw` | float | - | 四元数 w 分量 |
| `qx` | float | - | 四元数 x 分量 |
| `qy` | float | - | 四元数 y 分量 |
| `qz` | float | - | 四元数 z 分量 |
| `rpm` | int | RPM | 转速（转/分钟） |

### 5.2 WebSocket 命令（客户端 → 服务器）

客户端可通过 WebSocket 发送纯文本命令：

| 命令 | 说明 |
|------|------|
| `RESET` | 重置四元数为初始状态 |

---

## 6. 网页仪表盘功能

### 6.1 3D 网球可视化

- 使用 Canvas 2D API 渲染网球模型
- 绘制网球的绿色球体和白色缝线图案
- 基于四元数数据实时旋转缝线，与物理设备姿态同步
- 在球体下方显示旋转类型标签（TOPSPIN / BACKSPIN / SIDESPIN / FLAT）

### 6.2 陀螺仪实时曲线

- X/Y/Z 三轴滚动折线图
- X 轴为红色、Y 轴为绿色、Z 轴为蓝色
- 数据窗口：最近 250 个数据点（约 5 秒）
- 实时滚动更新，自动缩放 Y 轴范围
- 单位标注：°/s

### 6.3 加速度实时曲线

- X/Y/Z 三轴滚动折线图
- 配色与陀螺仪图表一致（红/绿/蓝）
- 数据窗口：最近 250 个数据点（约 5 秒）
- 实时滚动更新，自动缩放 Y 轴范围
- 单位标注：g

### 6.4 RPM 数字显示

- 大字号显示当前实时转速数值
- 显示旋转类型标签（基于三轴角速度分量占比判断）
- 旋转类型分类逻辑：
  - **TOPSPIN**：gx 为主导分量且为正
  - **BACKSPIN**：gx 为主导分量且为负
  - **SIDESPIN**：gy 或 gz 为主导分量
  - **FLAT**：RPM 低于阈值

### 6.5 连接状态指示

- 绿色圆点 + "Connected"：WebSocket 已连接
- 红色圆点 + "Disconnected"：WebSocket 断开
- 断开后自动重连（每 2 秒尝试一次）

### 6.6 操作按钮

- **录制开关（Record）**：点击开始记录数据到浏览器内存数组，再次点击停止录制
- **导出 CSV（Export CSV）**：将录制的数据下载为 CSV 文件，包含所有字段和表头
- **重置球（Reset）**：通过 WebSocket 发送 `RESET` 命令，重置设备端四元数

### 6.7 实现约束

- **纯前端实现**：HTML + CSS + JavaScript 全部写在一个文件中
- **无外部依赖**：不依赖任何 CDN 或第三方库，所有渲染逻辑手写实现
- **代码嵌入固件**：整个网页以 PROGMEM raw string literal 形式编译进固件
- **响应式布局**：适配手机竖屏和电脑横屏浏览

---

## 7. 技术栈

### 7.1 固件端

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 开发框架 | Arduino (PlatformIO) | ESP32-S3 Arduino 核心 |
| 硬件抽象 | M5Unified | M5Stack 官方统一库，提供 IMU / 屏幕 / 按键接口 |
| WebSocket | WebSockets by links2004 | 轻量级 ESP32 WebSocket 服务器库 |
| HTTP 服务器 | WebServer (ESP32 内置) | 提供静态网页服务 |
| JSON 序列化 | ArduinoJson 或手动拼接 | 构造 IMU 数据 JSON 包 |

### 7.2 前端

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 3D 渲染 | HTML5 Canvas 2D API | 原生 Canvas，手写 3D 投影和四元数旋转 |
| 图表 | Vanilla JavaScript | 手写折线图渲染，无第三方图表库 |
| 通信 | WebSocket API | 浏览器原生 WebSocket (ws://192.168.4.1:81) |
| 样式 | 内联 CSS | 深色主题，响应式布局 |

### 7.3 通信协议

- WiFi：802.11n, 2.4GHz, AP 模式
- HTTP：端口 80，GET / 返回网页
- WebSocket：端口 81，ws://192.168.4.1:81，双向通信

### 7.4 网页嵌入方式

使用 C++ raw string literal 配合 PROGMEM 将整个网页存储在 Flash 中：

```cpp
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
...整个网页代码...
</html>
)rawliteral";
```

---

## 8. UI 布局设计

### 8.1 整体布局

```
┌─────────────────────────────────────────┐
│  TennisBall IMU   ●Connected   [Reset]  │  ← 顶部导航栏
├──────────────────┬──────────────────────┤
│                  │                      │
│   [3D Tennis     │     1250 RPM         │  ← RPM 大字号显示
│    Ball]         │                      │
│                  │  ┌─ Gyro Chart ────┐ │
│                  │  │  X(red)         │ │  ← 陀螺仪实时曲线
│   TOPSPIN        │  │  Y(green)       │ │
│                  │  │  Z(blue)        │ │
│                  │  └─────────────────┘ │
│                  │  ┌─ Accel Chart ───┐ │
│                  │  │  X(red)         │ │  ← 加速度实时曲线
│                  │  │  Y(green)       │ │
│                  │  │  Z(blue)        │ │
│                  │  └─────────────────┘ │
├──────────────────┴──────────────────────┤
│  [● Record] [↓ Export CSV] [↻ Reset]   │  ← 底部操作栏
└─────────────────────────────────────────┘
```

### 8.2 布局说明

- **顶部导航栏**：项目名称居左，连接状态指示灯居中，重置按钮居右
- **左侧区域**：3D 网球可视化（Canvas），下方显示旋转类型标签
- **右侧上方**：RPM 数字大字号显示
- **右侧中部**：陀螺仪三轴实时折线图
- **右侧下方**：加速度三轴实时折线图
- **底部操作栏**：录制按钮、导出 CSV 按钮、重置按钮

### 8.3 配色方案

- 背景色：深色主题（#1a1a2e 或类似深蓝灰色）
- 网球颜色：标准网球荧光黄绿色（#ccff00）
- 图表背景：半透明深色（rgba(0,0,0,0.3)）
- X 轴曲线：红色（#ff4444）
- Y 轴曲线：绿色（#44ff44）
- Z 轴曲线：蓝色（#4444ff）
- 连接状态：绿色（#00ff00）/ 红色（#ff0000）
- 文字颜色：白色（#ffffff）
- 按钮：圆角深色背景 + 亮色边框

### 8.4 响应式适配

- **手机竖屏**：左右两栏改为上下排列（3D 球在上，图表在下）
- **电脑横屏**：左右两栏并排布局（如上图所示）
- 断点：768px

---

## 9. 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| WebSocket 推送频率 | 50Hz (20ms/包) | 固件端定时推送 |
| 网页渲染帧率 | ~30fps | 使用 requestAnimationFrame，数据到达时更新 |
| 图表数据窗口 | 250 个数据点 | 约 5 秒滚动窗口 |
| WiFi 延迟 | <10ms | AP 直连模式，无路由器中转 |
| 最大同时 WebSocket 客户端 | 3 | 避免 ESP32 内存溢出 |
| 网页总大小 | <50KB | 嵌入 PROGMEM，需控制体积 |
| 固件 Flash 占用 | <1.5MB | 含网页代码和所有库 |
| CSV 录制时长 | 取决于浏览器内存 | 前端内存数组存储，建议不超过 5 分钟 |

---

## 10. 使用流程

### 10.1 初始设置

1. 使用 PlatformIO 编译固件
2. 通过 USB-C 将固件烧录到 ATOM S3
3. 将 ATOM S3 安装/固定在网球上（或手持测试）

### 10.2 日常使用

1. **开机**：ATOM S3 上电，128x128 屏幕显示 WiFi SSID 和 IP 地址
2. **连接 WiFi**：手机或电脑连接 WiFi 热点 `TennisBall_IMU`，密码 `tennis123`
3. **打开仪表盘**：浏览器访问 `http://192.168.4.1`
4. **实时查看**：仪表盘自动连接 WebSocket，实时显示 3D 网球旋转、曲线图表和 RPM 数值
5. **录制数据**：点击 Record 按钮开始录制，再次点击停止
6. **导出数据**：点击 Export CSV 按钮，浏览器自动下载 CSV 文件
7. **重置姿态**：点击 Reset 按钮或按下 ATOM S3 正面按键，四元数归零

### 10.3 注意事项

- 连接 ATOM S3 的 WiFi 后，手机/电脑将无法访问互联网（AP 模式无外网）
- 建议在使用前先按 Reset 校准初始姿态
- 多个设备可同时连接查看，但建议不超过 3 个客户端以保证性能

---

## 11. 文件结构

```
ball_spin_webapp/
├── platformio.ini            # PlatformIO 项目配置
├── src/
│   └── main.cpp              # 固件主程序（WiFi AP + HTTP + WebSocket + IMU）
├── PRD.md                    # 本产品需求文档
└── README.md                 # 项目说明（如需要）
```

**main.cpp 核心模块划分**：

- WiFi AP 初始化与管理
- HTTP 服务器（提供 PROGMEM 网页）
- WebSocket 服务器（数据推送与命令接收）
- IMU 数据读取与四元数积分
- ATOM S3 屏幕刷新
- 按键事件处理
- 内嵌网页代码（PROGMEM HTML/CSS/JS）

---

## 12. 未来规划

### 12.1 短期优化

- 数据包压缩（MessagePack 替代 JSON，减少带宽占用）
- 网页加载进度提示
- 陀螺仪零偏自动校准

### 12.2 中期扩展

- **多传感器网络**：多个 ATOM S3 同时采集，汇聚到一个仪表盘展示
- **历史数据对比回放**：录制多次击球数据，在仪表盘上叠加对比分析
- **击球自动检测**：基于加速度突变检测击球瞬间，自动标记时间点
- **旋转分类算法**：使用机器学习或规则引擎自动分类旋转类型（上旋/下旋/侧旋）

### 12.3 长期愿景

- **PWA 离线缓存支持**：Service Worker 缓存网页，即使断开 WiFi 也能查看历史数据
- **蓝牙 BLE 备选通道**：在 WiFi 不可用时降级为 BLE 传输
- **云端数据同步**：连接外网时自动上传训练数据到云端
- **教练端多人监控**：一个教练端同时监控多名球员的实时旋转数据
