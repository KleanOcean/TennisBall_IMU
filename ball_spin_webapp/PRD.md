# YoTB WebApp - 产品需求文档 (PRD)

## 1. 项目概述

- **项目名称**：YoTB WebApp（Yoach Tennis Ball — 网球旋转无线仪表盘）
- **品牌名称**：**YoTB**（Yoach Tennis Ball）
- **目标**：将 M5Stack ATOM S3 的 IMU 数据通过 WiFi 实时推送到浏览器，实现大屏可视化分析，让教练和球员能够在手机或电脑上直观地观察网球旋转状态、转速及运动轨迹数据。
- **核心方案**：ESP32-S3 WiFi AP 模式 + WebSocket 实时通信 + 纯前端 Canvas 渲染
- **视觉风格**：深色科技风仪表盘，荧光黄绿色（#C8D820）线框渲染，赛博感十足
- **适用场景**：网球训练场地、室内击球分析、旋转教学演示

---

## 2. 系统架构

整个系统采用 ATOM S3 作为独立 WiFi 热点，无需依赖外部路由器，手机或电脑直接连接即可使用。

```
ATOM S3 (WiFi AP: "TennisBall_IMU")
    ├── HTTP Server (port 80) → 提供嵌入式网页（HTML/CSS/JS 全部存储在固件中）
    └── WebSocket Server (port 81) → 推送 IMU 数据 (50Hz JSON)
         │
    手机/电脑浏览器连接 WiFi → 打开 192.168.4.1
         │
    网页接收 WebSocket 数据 → Canvas 实时渲染
```

**数据流说明**：

1. ATOM S3 以 50Hz 频率读取 MPU6886 陀螺仪和加速度计原始数据
2. 固件内部进行四元数积分，计算当前姿态和转速（RPM）
3. 数据打包为 JSON 格式，通过 WebSocket 推送到所有已连接的浏览器客户端
4. 浏览器前端解析 JSON，驱动 3D 网球渲染、实时曲线图表和数值显示
5. 用户可在浏览器端录制数据并导出为 CSV 文件，也可发送命令重置四元数

---

## 3. 硬件规格

| 项目 | 规格 |
|------|------|
| 主控模块 | M5Stack ATOM S3 |
| 处理器 | ESP32-S3，双核 Xtensa LX7，主频 240MHz |
| IMU 传感器 | MPU6886（6 轴：3 轴加速度计 + 3 轴陀螺仪） |
| 屏幕 | 128x128 彩色 LCD |
| WiFi | 802.11 b/g/n，2.4GHz，支持 AP 模式 |
| 按键 | 正面 BtnA（可编程按键） |
| 供电 | USB-C 或锂电池 |

**ATOM S3 屏幕显示内容**：

- WiFi SSID 名称
- 设备 IP 地址（192.168.4.1）
- 当前已连接客户端数量
- 实时 RPM 转速数值

---

## 4. 固件功能

### 4.1 WiFi AP 模式

- SSID：`TennisBall_IMU`
- 密码：`tennis123`
- IP 地址：`192.168.4.1`（ESP32 AP 模式默认网关）
- 最大同时连接设备数：4 台（WiFi 层面）

### 4.2 HTTP 服务器

- 监听端口：80
- 提供完整的网页仪表盘（HTML + CSS + JavaScript）
- 网页代码以 PROGMEM raw string literal 形式嵌入固件，无需外部文件系统
- 访问 `http://192.168.4.1/` 即可加载完整仪表盘页面

### 4.3 WebSocket 服务器

- 监听端口：81
- 推送频率：50Hz（每 20ms 一包）
- 数据格式：JSON（详见第 5 节数据协议）
- 支持接收客户端命令（如重置四元数）
- 最大同时 WebSocket 客户端数：3

### 4.4 IMU 数据处理

- 陀螺仪读取：X/Y/Z 三轴角速度（单位：°/s）
- 加速度计读取：X/Y/Z 三轴加速度（单位：g）
- 四元数积分：基于陀螺仪数据实时积分计算姿态四元数（死区 0.05 rad/s ≈ 3°/s，抑制静止时陀螺仪漂移）
- RPM 计算：由角速度合成向量计算转速（转/分钟）

### 4.5 ATOM S3 屏幕显示

利用 128x128 彩色 LCD 显示关键运行状态：

- 第一行：WiFi SSID（`TennisBall_IMU`）
- 第二行：IP 地址（`192.168.4.1`）
- 第三行：已连接客户端数量（如 `Clients: 2`）
- 第四行：当前实时 RPM（如 `1250 RPM`）

### 4.6 按键功能

- **BtnA 短按**（< 1 秒）：重置四元数为初始状态（单位四元数 [1, 0, 0, 0]），将当前姿态归零
- **BtnA 长按**（≥ 3 秒）：进入 Light Sleep 低功耗休眠模式（详见 Feature #9）
- **BtnA 按下（休眠中）**：唤醒设备，恢复 WiFi AP、屏幕、IMU 采样

---

## 5. 数据协议

### 5.1 WebSocket 推送数据（服务器 → 客户端）

JSON 格式，每 20ms 推送一包：

```json
{
  "t": 12345,
  "ax": 0.01,
  "ay": 0.02,
  "az": 1.00,
  "gx": 120.5,
  "gy": -45.2,
  "gz": 890.1,
  "qw": 0.99,
  "qx": 0.01,
  "qy": 0.02,
  "qz": 0.03,
  "rpm": 150
}
```

**字段说明**：

| 字段 | 类型 | 单位 | 说明 |
|------|------|------|------|
| `t` | int | ms | 设备启动以来的时间戳（millis） |
| `ax` | float | g | 加速度计 X 轴 |
| `ay` | float | g | 加速度计 Y 轴 |
| `az` | float | g | 加速度计 Z 轴 |
| `gx` | float | °/s | 陀螺仪 X 轴角速度 |
| `gy` | float | °/s | 陀螺仪 Y 轴角速度 |
| `gz` | float | °/s | 陀螺仪 Z 轴角速度 |
| `qw` | float | - | 四元数 w 分量 |
| `qx` | float | - | 四元数 x 分量 |
| `qy` | float | - | 四元数 y 分量 |
| `qz` | float | - | 四元数 z 分量 |
| `rpm` | int | RPM | 转速（转/分钟） |

### 5.2 WebSocket 命令（客户端 → 服务器）

客户端可通过 WebSocket 发送纯文本命令：

| 命令 | 说明 |
|------|------|
| `RESET` | 重置四元数为初始状态 |

---

## 6. 网页仪表盘功能（YoTB Dashboard）

### 6.1 导航与品牌

- 顶部导航栏左上角显示品牌 Logo **"YoTB"**（粗体白色文字）
- 导航标签页：**DASHBOARD** | **SHOTS** | **ANALYSIS** | **SETTINGS**
- 导航栏右侧：通知铃铛图标、绿色连接状态圆点、已连接设备数量
- 移动端：顶部紧凑型标签栏

### 6.2 3D 线框网球可视化（DASHBOARD 标签页 — 核心视觉元素）

- 使用 Canvas 2D API 渲染 **线框（wireframe）网球模型** — 测地线球体（Geodesic Sphere / Icosphere）
- 基于正二十面体细分算法生成均匀三角形网格，一次细分约 80 个三角面、120 条边，三角形大小均匀分布，无极点汇聚问题
- 网球缝线曲线以更亮、更粗的荧光黄绿色线框绘制
- 每条边根据深度（z 值）调节透明度：前面亮（0.8-1.0），背面暗（0.1-0.15）
- 所有线条颜色统一为荧光黄绿色（#C8D820）
- 球体外围添加 **多层辉光效果**：内层高亮（opacity 0.15）+ 外层扩散（opacity 0.06），半径扩展至球体半径的 1.5 倍，营造强烈的霓虹灯管视觉效果
- 深色背景（#0a0e27）衬托绿色线框，视觉冲击力强
- 基于四元数数据实时旋转，与物理设备姿态同步；**当实体球静止时，线框球必须保持静止**（固件端陀螺仪死区过滤确保无漂移）
- 透视投影渲染：远处线条更暗/更细，近处更亮/更粗
- Canvas 尺寸：桌面端 400x400，移动端响应式缩放

#### 6.2.1 网球渲染模式切换

在 3D 网球可视化区域添加渲染模式切换开关，用户可在两种视觉风格间自由切换：

**模式 A：线框模式（Wireframe）** — 当前默认
- 荧光黄绿色（#C8D820）经纬线框 + 缝线
- 深度透视（远处暗、近处亮）
- 霓虹辉光效果
- 科技感、赛博风格

**模式 B：实体网球模式（Solid）**
- 经典网球外观：荧光黄绿色实体球（径向渐变模拟光照）
- 白色缝线曲线（同一条 seam 算法，lineWidth 2-3px）
- 背面缝线半透明处理
- 球体边缘描边
- 真实感、直观风格

**切换交互**：
- 在球体区域右上角放置小型切换按钮（图标或文字标签：🔲/🟢 或 "线框/实体"）
- 点击切换，动画过渡（可选）
- 用户偏好保存到 localStorage，下次打开自动恢复
- 两种模式共用同一套四元数旋转逻辑

### 6.3 RPM 半圆弧仪表盘（DASHBOARD 标签页）

- **270° 弧形仪表**（从 7 点钟位置到 5 点钟位置扫过）
- 灰色底轨（#222244）作为背景弧
- 荧光黄绿色（#C8D820）填充弧，长度与当前 RPM 成正比
- 弧内中央显示大号粗体 RPM 数值（荧光黄绿色）
- 数值下方显示 "RPM" 标签（较小字号，灰色文字）
- 再下方显示旋转类型标签（白色文字，如 "TOPSPIN"）
- 最大 RPM 刻度可配置（默认 3000）
- 填充弧动画过渡，平滑跟随数据变化

### 6.4 实时折线图（DASHBOARD 标签页）

- 标题："REAL TIME CHART"
- 单线滚动折线图，显示角速度（或 RPM）随时间变化
- 荧光黄绿色（#C8D820）折线
- 深色背景（#0a0e27）
- Y 轴刻度标签（灰色文字）
- X 轴时间戳（MM:SS 格式）
- 网格线使用极浅深色（#1a2040），不干扰数据线
- 数据窗口：最近 250 个数据点（约 5 秒）

### 6.5 击球时间线（DASHBOARD 标签页）

- 标题："SHOT TIMELINE"
- 水平排列的彩色圆点行
- 荧光黄绿色圆点 = 检测到击球，灰色圆点 = 低活动状态
- 位于实时折线图下方

### 6.6 连接状态指示

- 导航栏右侧绿色圆点 + 设备数量计数器：WebSocket 已连接
- 红色圆点：WebSocket 断开
- 断开后自动重连（每 2 秒尝试一次）

### 6.7 SETTINGS 标签页

- WiFi 信息展示（SSID、密码、IP 地址）
- 校准按钮（重置四元数）
- 录制控制（开始/停止录制、导出 CSV）

### 6.8 旋转类型分类逻辑

- 旋转类型基于三轴角速度分量占比判断：
  - **TOPSPIN**：gx 为主导分量且为正
  - **BACKSPIN**：gx 为主导分量且为负
  - **SIDESPIN**：gy 或 gz 为主导分量
  - **FLAT**：RPM 低于阈值

### 6.9 实现约束

- **纯前端实现**：HTML + CSS + JavaScript 全部写在一个文件中
- **无外部依赖**：不依赖任何 CDN 或第三方库，所有渲染逻辑手写实现
- **代码嵌入固件**：整个网页以 PROGMEM raw string literal 形式编译进固件
- **响应式布局**：适配手机竖屏和电脑/平板横屏浏览
- **统一视觉语言**：与 Observer 仪表盘共享同一套 YoTB 品牌视觉规范

---

## Feature #2: 击球瞬间自动检测 (Impact Detection)

### 概述

利用加速度计数据的突变自动识别击球瞬间，无需用户手动标记。固件端负责检测逻辑，Web 端负责可视化呈现。

### 功能需求

- 利用加速度计突变（>4g 阈值）自动识别击球瞬间
- 记录击球前后的数据窗口，便于事后分析击球过程
- 击球事件通过 WebSocket 发送特殊 JSON 消息（与常规数据流区分）
- 固件端完成检测计算，Web 端接收事件后显示标记

### 检测算法

- **触发条件**：加速度向量幅值 `sqrt(ax² + ay² + az²) > 4.0g`
- **冷却期**：触发后加 200ms 冷却期，防止同一次击球重复触发
- **检测频率**：跟随 IMU 采样频率（50Hz），每次读取加速度数据时执行判断

### 击球记录内容

每次检测到击球事件时，记录以下信息：

| 字段 | 说明 |
|------|------|
| 时间戳 | 击球发生的设备时间（ms） |
| 峰值 RPM | 击球瞬间的最大转速 |
| 峰值 G 力 | 击球瞬间的最大加速度幅值 |
| 旋转类型 | 击球瞬间的旋转分类结果（见 Feature #3） |

### Web 端显示

- 击球瞬间在图表上显示竖直标记线
- 弹出短暂通知提示击球检测到
- 击球事件记入击球列表（见 Feature #8 时间线）

---

## Feature #3: 旋转类型智能分类 (Spin Classification)

### 概述

基于三轴陀螺仪数据的主导轴比例，自动将每次旋转分类为具体的旋转类型，帮助教练和球员快速理解球的旋转特征。

### 分类类型

| 类型 | 英文 | 说明 |
|------|------|------|
| 上旋 | TOPSPIN | 球向前翻转，产生下坠弧线 |
| 下旋 | BACKSPIN | 球向后翻转，产生漂浮弧线 |
| 侧旋 | SIDESPIN | 球水平旋转，产生左右偏移 |
| 平击 | FLAT | 几乎无旋转，直线飞行 |
| 切削 | SLICE | 球斜向旋转，产生侧切效果 |

### 分类算法

分类基于三轴陀螺仪读数（gx, gy, gz）的绝对值占比和符号方向：

1. **计算各轴绝对值占比**：
   - `ratio_x = |gx| / (|gx| + |gy| + |gz|)`
   - `ratio_y = |gy| / (|gx| + |gy| + |gz|)`
   - `ratio_z = |gz| / (|gx| + |gy| + |gz|)`

2. **分类判定规则**（按优先级排列）：
   - 若 RPM < 300 → 判定为 **FLAT**（平击）
   - 若主导轴占比 > 60%，判定单一类型：
     - **gx 主导**（ratio_x > 60%）：
       - gx 为正值 → **TOPSPIN**（上旋）
       - gx 为负值 → **BACKSPIN**（下旋）
     - **gy 主导**（ratio_y > 60%）→ **SIDESPIN**（侧旋）
     - **gz 主导**（ratio_z > 60%）→ **SLICE**（切削）
   - 若无单一主导轴 → 取绝对值最大的轴按上述规则判定

### 考虑因素

- 各轴占比用于区分旋转的主导方向
- 符号（正/负）用于区分上旋与下旋、左侧旋与右侧旋
- RPM 阈值用于过滤噪声，避免静止状态下产生误判

### Web 端显示

- 旋转类型以白色文字标签形式显示在 RPM 半圆弧仪表下方
- 标签背景为深色卡片（#111633），文字为白色（#FFFFFF）
- 各类型在击球时间线和极坐标图中以颜色区分：
  - TOPSPIN：珊瑚红（#FF6B6B）
  - BACKSPIN：青绿（#4ECDC4）
  - SIDESPIN：明黄（#FFE66D）
  - FLAT：灰色（#888888）
  - SLICE：薄荷绿（#A8E6CF）

---

## Feature #8: 多球对比时间线 (Multi-Shot Timeline)

### 概述

录制一段练习后，以水平时间线形式展示所有击球事件，便于教练和球员回顾整段练习的击球质量和旋转变化趋势。

### 功能需求

- 录制一段练习后，以时间线形式展示所有击球事件
- 每个击球标记显示 RPM、旋转类型、峰值加速度
- 可选中某次击球查看详细数据
- 提供击球统计汇总信息

### 击球统计汇总

在时间线区域上方显示以下汇总数据：

| 统计项 | 说明 |
|--------|------|
| 总击球数 | 本次录制期间检测到的击球次数 |
| 平均 RPM | 所有击球的平均转速 |
| 最高 RPM | 所有击球中的最大转速 |
| 旋转类型分布 | 各旋转类型占比（如 TOPSPIN 60%，SIDESPIN 30%，FLAT 10%） |

### Web UI 布局

- 时间线位于 Web 页面底部区域
- 水平方向表示时间轴，从录制开始到结束
- 每次击球在时间轴上显示为一个圆形标记点
- 标记点颜色对应旋转类型（与 Feature #3 颜色方案一致）
- 标记点上方显示 RPM 数值

### 交互设计

- 点击击球标记弹出详情面板，显示该次击球的完整数据：
  - 击球时间（相对录制起始时间）
  - RPM 数值
  - 旋转类型
  - 峰值加速度（G 力）
  - gx / gy / gz 各轴角速度
- 详情面板可关闭
- 时间线支持水平滚动（当击球次数较多时）

---

## WebSocket 协议更新

### 常规数据流更新

在现有 WebSocket 推送数据包中新增 `imp` 字段，用于标识当前数据帧是否对应击球瞬间：

```json
{
  "t": 12345,
  "ax": 0.01, "ay": 0.02, "az": 1.00,
  "gx": 120.5, "gy": -45.2, "gz": 890.1,
  "qw": 0.99, "qx": 0.01, "qy": 0.02, "qz": 0.03,
  "rpm": 150,
  "imp": 1
}
```

- `"imp": 1`：当检测到击球时附带此字段，表示当前帧为击球帧
- 未检测到击球时，`imp` 字段省略或为 0，以节省带宽

### 新增击球事件消息

当固件端检测到击球事件时，额外发送一条独立的击球事件 JSON 消息：

```json
{
  "event": "shot",
  "id": N,
  "t": ms,
  "rpm": X,
  "type": "TOPSPIN",
  "peakG": Y,
  "gx": value,
  "gy": value,
  "gz": value
}
```

**字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| `event` | string | 事件类型，固定为 `"shot"` |
| `id` | int | 击球序号，从 1 开始递增，设备重启后归零 |
| `t` | int | 击球时间戳（设备 millis，单位 ms） |
| `rpm` | int | 击球瞬间峰值 RPM |
| `type` | string | 旋转类型分类结果（`TOPSPIN` / `BACKSPIN` / `SIDESPIN` / `FLAT` / `SLICE`） |
| `peakG` | float | 击球瞬间峰值 G 力（加速度向量幅值） |
| `gx` | float | 击球瞬间陀螺仪 X 轴角速度（°/s） |
| `gy` | float | 击球瞬间陀螺仪 Y 轴角速度（°/s） |
| `gz` | float | 击球瞬间陀螺仪 Z 轴角速度（°/s） |

---

## 7. 技术栈

### 7.1 固件端

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 开发框架 | Arduino (PlatformIO) | ESP32-S3 Arduino 核心 |
| 硬件抽象 | M5Unified | M5Stack 官方统一库，提供 IMU / 屏幕 / 按键接口 |
| WebSocket | WebSockets by links2004 | 轻量级 ESP32 WebSocket 服务器库 |
| HTTP 服务器 | WebServer (ESP32 内置) | 提供静态网页服务 |
| JSON 序列化 | ArduinoJson 或手动拼接 | 构造 IMU 数据 JSON 包 |

### 7.2 前端

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 3D 渲染 | HTML5 Canvas 2D API | 原生 Canvas，手写 3D 投影和四元数旋转 |
| 图表 | Vanilla JavaScript | 手写折线图渲染，无第三方图表库 |
| 通信 | WebSocket API | 浏览器原生 WebSocket (ws://192.168.4.1:81) |
| 样式 | 内联 CSS | 深色主题，响应式布局 |

### 7.3 通信协议

- WiFi：802.11n, 2.4GHz, AP 模式
- HTTP：端口 80，GET / 返回网页
- WebSocket：端口 81，ws://192.168.4.1:81，双向通信

### 7.4 网页嵌入方式

使用 C++ raw string literal 配合 PROGMEM 将整个网页存储在 Flash 中：

```cpp
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
...整个网页代码...
</html>
)rawliteral";
```

---

## 8. UI 布局设计（YoTB Dashboard）

### 8.1 导航栏设计

```
┌─────────────────────────────────────────────────────────────────┐
│  YoTB    [DASHBOARD] [SHOTS] [ANALYSIS] [SETTINGS]    🔔 ●2   │
│  (粗体)   (活跃标签高亮)                            (铃铛)(设备数)│
└─────────────────────────────────────────────────────────────────┘
```

- **左上角**：品牌名 **YoTB**，粗体白色文字，作为 Logo
- **中部标签页**：DASHBOARD | SHOTS | ANALYSIS | SETTINGS
  - **激活标签页**：白色胶囊形背景 + 深色文字（#fff 背景，#0a0e27 文字）
  - **非激活标签页**：透明背景 + 灰色文字（#667788）
  - **标签页切换**：平滑过渡动画
- **右侧**：通知铃铛图标 + 绿色连接圆点 + 已连接设备数量
- **背景色**：与页面主背景一致（#0a0e27），或略深

### 8.2 DASHBOARD 标签页 — 桌面/平板布局（三栏布局）

```
┌─────────────────────────────────────────────────────────────────┐
│  YoTB    [DASHBOARD] [SHOTS] [ANALYSIS] [SETTINGS]    🔔 ●2   │
├──────────────┬──────────────────────┬───────────────────────────┤
│              │                      │                           │
│  ╭────────╮  │     ╭──────────╮     │  REAL TIME CHART          │
│  │ ╲    ╱ │  │    ╱  线框网球  ╲    │  ┌───────────────────┐    │
│  │  ╲  ╱  │  │   │   ○        │    │  │  ╱╲   ╱╲         │    │
│  │   ──   │  │   │  wireframe │    │  │ ╱  ╲ ╱  ╲  ╱╲   │    │
│  │  1850  │  │   │   seam     │    │  │╱    ╳    ╲╱  ╲  │    │
│  │  RPM   │  │   │   (glow)   │    │  └───────────────────┘    │
│  │TOPSPIN │  │    ╲          ╱     │                           │
│  ╰────────╯  │     ╰────────╯      │  SHOT TIMELINE            │
│              │                      │  ● ● ○ ● ○ ● ● ○ ●      │
│  左栏 ~25%   │    中栏 ~40%         │  右栏 ~35%                │
├──────────────┴──────────────────────┴───────────────────────────┤
│  击球检测时全屏荧光黄绿色闪烁覆盖层（150ms 淡出）                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 左栏（约 25%）— RPM 半圆弧仪表

- **270° 半圆弧仪表**（从 7 点钟位置到 5 点钟位置）
- 灰色底轨弧线（#222244）
- 荧光黄绿色（#C8D820）填充弧，长度与 RPM 数值成正比
- 弧内中央：大号粗体 RPM 数值，如 "1850"，颜色为荧光黄绿色
- 数值下方："RPM" 标签（较小字号，灰色 #667788）
- 再下方：旋转类型文字，如 "TOPSPIN"（白色文字）
- 最大 RPM 刻度：可配置（默认 3000）
- 填充弧带动画过渡效果

#### 中栏（约 40%）— 3D 线框网球（核心视觉 HERO 元素）

- Canvas 渲染的 **线框球体**，具有经线/纬线网格（每 30° 一条）
- 网球缝线曲线以荧光黄绿色线框高亮渲染（更亮、更粗）
- 球体外围 **霓虹辉光效果**：`0 0 40px rgba(200,216,32,0.3)`
- 基于四元数数据 **实时旋转**，与 IMU 设备姿态同步
- 深色背景使绿色线框极为醒目
- 透视投影：远处线条更暗更细，近处更亮更粗
- Canvas 尺寸：桌面端 400x400

#### 右栏（约 35%）— 实时图表 + 击球时间线

- **"REAL TIME CHART" 标题**（白色文字，偏小字号）
- 折线图：角速度或 RPM 随时间滚动
  - 荧光黄绿色折线（#C8D820）
  - 深色背景（#0a0e27）
  - Y 轴刻度标签（灰色 #667788）
  - X 轴时间戳（MM:SS 格式，灰色）
  - 网格线（#1a2040，极浅，不干扰数据线）
  - 数据窗口：最近 250 个点（约 5 秒）
- **"SHOT TIMELINE" 标题**（位于折线图下方）
  - 水平排列的彩色圆点
  - 荧光黄绿色实心圆点 = 检测到击球
  - 灰色圆点 = 低活动区间
  - 支持水平滚动

### 8.3 DASHBOARD 标签页 — 移动端/手机布局（纵向堆叠）

```
┌──────────────────────────┐
│  YoTB  [D][S][A][SET]    │  ← 紧凑标签栏
├──────────────────────────┤
│                          │
│      ╭──────────╮        │
│     ╱  线框网球  ╲       │  ← 3D 线框球（较小尺寸）
│    │   wireframe │       │
│     ╲   (glow)  ╱        │
│      ╰──────────╯        │
│                          │
│     1850 RPM             │  ← 大号加粗 RPM 数值（颜色 #C8D820）
│     TOPSPIN              │  ← 旋转类型标签
│                          │
│  ┌────────────────────┐  │
│  │  实时折线图 (小型)  │  │  ← 缩小版实时图表
│  └────────────────────┘  │
│                          │
│  ● ● ○ ● ○ ● ● ○ ●     │  ← 击球时间线（底部）
└──────────────────────────┘
```

- 顶部紧凑标签栏（标签名缩写或图标）
- 3D 线框球居中显示（尺寸响应式缩放）
- **移动端 RPM 显示**：不显示仪表弧，改为大号加粗文字居中显示（如 "1850 RPM"），颜色 #C8D820
- 旋转类型标签紧跟 RPM 下方
- 缩小版实时折线图
- 击球时间线在最底部

### 8.4 SETTINGS 标签页布局

- WiFi 信息展示区域（SSID、密码、IP 地址）
- 校准控制（重置四元数按钮）
- 录制控制（开始/停止录制按钮、导出 CSV 按钮）
- 所有按钮使用圆角深色卡片背景 + 荧光黄绿色边框/文字

### 8.5 ATOM S3 屏幕布局（128x128 像素）— 不变

ATOM S3 小屏幕保持现有布局设计，不采用 YoTB 仪表盘新视觉风格：

```
┌────────────────────────┐
│       1250 RPM         │  ← 大字号 RPM（顶部居中）
│    或  READY（静止时）   │
│                        │
│     ┌──────────┐       │
│     │ ○ Tennis │       │  ← 3D 网球（缝线随四元数旋转）
│     │   Ball   │       │     半径 30px，中心 (64, 52)
│     │  (seam)  │       │
│     └──────────┘       │
│                        │
│ ●2 connected  3 shots  │  ← 连接状态（绿点）+ 击球数（橙色）
│ TennisBall_IMU         │  ← WiFi SSID（灰色）
│ pw: tennis123          │  ← 密码（灰色）
│ 192.168.4.1            │  ← IP 地址（青色）
└────────────────────────┘
```

### 8.6 布局说明

- **导航栏**：品牌 "YoTB" 居左，四个标签页居中，连接状态与设备计数居右
- **DASHBOARD 三栏布局**：
  - 左栏（25%）：RPM 半圆弧仪表 + 旋转类型标签
  - 中栏（40%）：3D 线框网球核心视觉元素（HERO），带霓虹辉光
  - 右栏（35%）：实时折线图 + 击球时间线
- **移动端**：三栏改为纵向堆叠（球 → RPM → 图表 → 时间线）
- **SETTINGS 标签页**：WiFi 信息 + 校准按钮 + 录制控制
- **击球闪烁**：检测到击球时全屏荧光黄绿色半透明覆盖层闪烁 150ms
- **ATOM S3 屏幕**：保持现有设计不变（RPM + 旋转网球 + WiFi 信息 + 击球计数）

### 8.7 YoTB 配色方案

#### 基础色板

| 用途 | 色值 | 说明 |
|------|------|------|
| 页面背景 | **#0a0e27** | 极深藏青色，接近纯黑 |
| 卡片/面板背景 | **#111633** | 略浅藏青色 |
| 主强调色 | **#C8D820** | 荧光黄绿色 — RPM 数值、仪表弧填充、线框球、折线图 |
| 主要文字 | **#FFFFFF** | 纯白色 |
| 次要文字 | **#667788** | 柔和蓝灰色 |
| 仪表底轨 | **#222244** | 深灰蓝色 |
| 图表网格线 | **#1a2040** | 极浅深色，几乎不可见 |
| 线框球辉光 | `0 0 40px rgba(200,216,32,0.3)` | 荧光黄绿色外发光 |

#### 旋转类型配色

| 旋转类型 | 颜色名 | 色值 |
|----------|--------|------|
| TOPSPIN（上旋） | 珊瑚红 | #FF6B6B |
| BACKSPIN（下旋） | 青绿 | #4ECDC4 |
| SIDESPIN / SIDE_L / SIDE_R（侧旋） | 明黄 | #FFE66D |
| SLICE（切削） | 薄荷绿 | #A8E6CF |
| FLAT（平击） | 灰色 | #888888 |
| MIXED（混合） | 淡紫 | #DDA0DD |

#### 视觉风格说明

- 整体视觉走 **深色科技风（Dark Tech）** 路线
- 以单一强调色（荧光黄绿 #C8D820）统一所有关键数据元素
- 背景极深且带蓝调，营造专业运动科技感
- 线框网球的霓虹辉光是视觉焦点，传达动感与精密感
- 卡片与面板使用微妙的深浅层次区分，避免纯黑的单调

### 8.8 响应式适配

- **桌面/平板（宽度 > 768px）**：三栏并排布局（左 25% / 中 40% / 右 35%）
- **手机竖屏（宽度 <= 768px）**：纵向堆叠排列（球 → RPM → 图表 → 时间线）
- 断点：768px
- 3D 线框球 Canvas 响应式缩放
- 导航标签在移动端切换为紧凑模式（缩写或图标）
- 击球时间线区域支持水平滚动（击球标记超出可视宽度时）

### 8.9 关键视觉元素详细规格

#### RPM 半圆弧仪表

| 属性 | 规格 |
|------|------|
| 弧度范围 | 270°（7 点钟 → 5 点钟） |
| 底轨颜色 | #222244（深灰蓝） |
| 填充颜色 | #C8D820（荧光黄绿） |
| 中央数字 | 大号粗体，荧光黄绿色 |
| "RPM" 标签 | 小号，灰色（#667788） |
| 旋转类型 | 白色文字（#FFFFFF） |
| 最大刻度 | 可配置（默认 3000 RPM） |
| 动画 | 填充弧平滑过渡 |

#### 3D 线框网球 — 测地线球体（Geodesic Sphere）

| 属性 | 规格 |
|------|------|
| 网格类型 | 测地线球体（Geodesic Sphere / Icosphere）— 基于正二十面体细分算法生成均匀三角形网格 |
| 一次细分网格 | 约 80 个三角面、120 条边，三角形大小均匀分布，无极点汇聚问题（优于经纬线网格） |
| 线条颜色 | #C8D820（荧光黄绿） |
| 深度透明度调节 | 每条边根据深度（z 值）调节透明度：前面亮（0.8-1.0），背面暗（0.1-0.15） |
| 缝线渲染 | 缝线曲线以更亮更粗的线条叠加绘制，突出显示 |
| 辉光效果 | `0 0 40px rgba(200,216,32,0.3)` |
| 投影方式 | 透视投影（远暗近亮） |
| Canvas 尺寸 | 桌面 400x400，移动端响应式 |
| 旋转驱动 | 四元数实时数据 |

#### 实时折线图

| 属性 | 规格 |
|------|------|
| 折线颜色 | #C8D820（荧光黄绿） |
| 背景色 | #0a0e27（页面背景同色） |
| 网格线 | #1a2040（极浅） |
| Y 轴标签 | 灰色（#667788） |
| X 轴格式 | MM:SS 时间戳 |
| 数据窗口 | 250 个数据点（约 5 秒） |
| 滚动方式 | 从右向左实时滚动 |

---

## 9. 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| WebSocket 推送频率 | 50Hz (20ms/包) | 固件端定时推送 |
| 网页渲染帧率 | ~30fps | 使用 requestAnimationFrame，数据到达时更新 |
| 图表数据窗口 | 250 个数据点 | 约 5 秒滚动窗口 |
| WiFi 延迟 | <10ms | AP 直连模式，无路由器中转 |
| 最大同时 WebSocket 客户端 | 3 | 避免 ESP32 内存溢出 |
| 网页总大小 | <50KB | 嵌入 PROGMEM，需控制体积 |
| 固件 Flash 占用 | <1.5MB | 含网页代码和所有库 |
| CSV 录制时长 | 取决于浏览器内存 | 前端内存数组存储，建议不超过 5 分钟 |

---

## 10. 使用流程

### 10.1 初始设置

1. 使用 PlatformIO 编译固件
2. 通过 USB-C 将固件烧录到 ATOM S3
3. 将 ATOM S3 安装/固定在网球上（或手持测试）

### 10.2 日常使用

1. **开机**：ATOM S3 上电，128x128 屏幕显示 WiFi SSID 和 IP 地址
2. **连接 WiFi**：手机或电脑连接 WiFi 热点 `TennisBall_IMU`，密码 `tennis123`
3. **打开仪表盘**：浏览器访问 `http://192.168.4.1`
4. **实时查看**：仪表盘自动连接 WebSocket，实时显示 3D 网球旋转、曲线图表和 RPM 数值
5. **录制数据**：点击 Record 按钮开始录制，再次点击停止
6. **导出数据**：点击 Export CSV 按钮，浏览器自动下载 CSV 文件
7. **重置姿态**：点击 Reset 按钮或按下 ATOM S3 正面按键，四元数归零

### 10.3 注意事项

- 连接 ATOM S3 的 WiFi 后，手机/电脑将无法访问互联网（AP 模式无外网）
- 建议在使用前先按 Reset 校准初始姿态
- 多个设备可同时连接查看，但建议不超过 3 个客户端以保证性能

---

## 11. 文件结构

```
ball_spin_webapp/
├── platformio.ini            # PlatformIO 项目配置
├── src/
│   └── main.cpp              # 固件主程序（WiFi AP + HTTP + WebSocket + IMU）
├── PRD.md                    # 本产品需求文档
└── README.md                 # 项目说明（如需要）
```

**main.cpp 核心模块划分**：

- WiFi AP 初始化与管理
- HTTP 服务器（提供 PROGMEM 网页）
- WebSocket 服务器（数据推送与命令接收）
- IMU 数据读取与四元数积分
- ATOM S3 屏幕刷新
- 按键事件处理
- 内嵌网页代码（PROGMEM HTML/CSS/JS）

---

## Feature #9: 低功耗休眠模式 (Light Sleep Power Saving)

### 概述

当网球暂时不使用时（比赛间歇、休息、放包里），用户可通过长按 BtnA 3 秒让设备进入 ESP32-S3 Light Sleep 低功耗模式，大幅降低电池消耗。再次按下按钮即可唤醒恢复正常工作。

### 用户交互

| 操作 | 动作 | 说明 |
|------|------|------|
| **短按 BtnA** | 重置四元数 | 现有功能不变，将姿态归零 |
| **长按 BtnA 3 秒** | 进入 Light Sleep | 关闭屏幕、WiFi、停止 IMU 采样，进入低功耗休眠 |
| **按下 BtnA（休眠中）** | 唤醒恢复 | 重新初始化屏幕、WiFi AP、WebSocket 服务器 |

### 进入休眠流程

1. 用户持续按住 BtnA
2. 按住达到 1 秒时：屏幕显示进度提示（如倒计时条或文字 "SLEEP 2..."）
3. 按住达到 2 秒时：进度更新 "SLEEP 1..."
4. 按住达到 3 秒时：
   - 屏幕短暂显示 "SLEEPING..." 提示
   - 关闭 LCD 背光
   - 停止 WebSocket 服务器（所有客户端断线）
   - 停止 HTTP 服务器
   - 关闭 WiFi AP
   - 配置 GPIO 中断唤醒源（BtnA 引脚）
   - 进入 ESP32-S3 Light Sleep 模式
5. 如果用户在 3 秒内松手，取消休眠流程，恢复正常操作

### 唤醒恢复流程

1. 用户按下 BtnA → GPIO 中断唤醒 ESP32-S3
2. 恢复顺序（约 1-2 秒完成）：
   - 重新开启 LCD 背光
   - 屏幕显示 "WAKING UP..." 提示
   - 重新启动 WiFi AP（SSID / 密码不变）
   - 重新启动 HTTP + WebSocket 服务器
   - 恢复 IMU 采样和数据推送
   - 屏幕恢复正常显示
3. **RAM 保留**：Light Sleep 模式保留 RAM 内容
   - 四元数姿态状态保留（orient）
   - 击球记录保留（shots 数组、shotCount）
   - 陀螺仪偏置校准值保留（gyroBias）
   - 滤波器状态保留

### 功耗对比

| 模式 | 典型功耗 | 说明 |
|------|----------|------|
| 正常工作 | ~120mA | WiFi AP + IMU 采样 + 屏幕 + WebSocket 推送 |
| Light Sleep | ~0.8mA | CPU 暂停、WiFi 关闭、屏幕关闭、RAM 保留 |
| 节电倍率 | **~150x** | 续航延长约 150 倍 |

### ATOM S3 屏幕提示

#### 长按进度显示 — 海平面上升动画

长按超过 1 秒后，屏幕底部开始出现一片半透明的青色（Cyan）"海水"，从底部向顶部逐渐上升，模拟海平面上升效果：

```
┌────────────────────────┐          ┌────────────────────────┐
│       1250 RPM         │          │                        │
│     ╭──────────╮       │          │          1             │  ← 倒计时数字漂浮在水面上方
│     │  Tennis  │       │          │  ~~~~~~~~~ ← 波浪线    │
│     │  Ball    │       │   ──→    │ ░░░░░░░░░░░░░░░░░░░░░ │  ← 半透明青色海水覆盖
│     ╰──────────╯       │          │ ░░░░░░░░░░░░░░░░░░░░░ │     原有画面仍可见
│       2                │          │ ░░░░░░░░░░░░░░░░░░░░░ │
│ ░░░░░░░░░░░░░░░░░░░░░ │          │ ░░░░░░░░░░░░░░░░░░░░░ │
│ ░░░░░░░░░░░░░░░░░░░░░ │          │ ░░░░░░░░░░░░░░░░░░░░░ │
└────────────────────────┘          └────────────────────────┘
      按住 ~1.5 秒                        按住 ~2.8 秒
```

**视觉效果**：
- **水面线**：明亮青色（0x07FF）单像素水平线，标记当前水位
- **浅层（水面下 0-3px）**：亮青色，模拟波峰透光
- **中层（3-8px）**：中等青色，过渡色
- **深层（>8px）**：深暗青色，模拟深水
- **半透明效果**：棋盘格交错绘制像素（隔一个画一个），原有的网球和文字仍透过海水隐约可见
- **倒计时数字**：粗体青色数字（3→2→1）漂浮在水面正上方
- 当海水完全淹没整个屏幕（progress=100%），3 秒到达，进入 Light Sleep

#### 休眠前最后画面

```
┌────────────────────────┐
│                        │
│                        │
│      💤 SLEEPING...    │
│                        │
│    Press to wake up    │
│                        │
└────────────────────────┘
```

画面显示约 500ms 后关闭屏幕背光。

### 技术实现要点

1. **长按检测**：在 `loop()` 中持续检测 BtnA 按下状态和持续时间
   - 使用 `M5.BtnA.isPressed()` 检测持续按住
   - 记录按下起始时间，计算持续时长
   - 3 秒内松手则取消，超过 3 秒则触发休眠

2. **GPIO 唤醒配置**：
   - ATOM S3 的 BtnA 连接到 GPIO 41
   - 使用 `esp_sleep_enable_gpio_wakeup()` 配置 GPIO 唤醒
   - 设置低电平触发（按钮按下时为低电平）

3. **WiFi 恢复**：
   - Light Sleep 后 WiFi 状态丢失，需要重新调用 `WiFi.softAP()` 重建 AP
   - WebSocket 和 HTTP 服务器需要重新初始化监听

4. **IMU 恢复**：
   - MPU6886 可能需要重新初始化
   - 或者 Light Sleep 后 I2C 总线自动恢复（需测试）

### 注意事项

- Light Sleep 期间所有 WebSocket 客户端（手机、笔记本 Observer）将断线
- Observer 端有自动重连机制（每 2 秒重试），唤醒后 2-4 秒内自动恢复连接
- 边缘端 WebApp 也有自动重连，唤醒后浏览器自动重连 WebSocket
- 短按（<1 秒）仍执行原有的四元数重置功能，不会触发休眠
- 长按期间如果中途松手（1-3 秒之间），取消休眠，不执行任何操作

---

## 12. 未来规划

### 12.1 短期优化

- 数据包压缩（MessagePack 替代 JSON，减少带宽占用）
- 网页加载进度提示
- 陀螺仪零偏自动校准

### 12.2 中期扩展

- **多传感器网络**：多个 ATOM S3 同时采集，汇聚到一个仪表盘展示
- **历史数据对比回放**：录制多次击球数据，在仪表盘上叠加对比分析
- **击球自动检测**：基于加速度突变检测击球瞬间，自动标记时间点
- **旋转分类算法**：使用机器学习或规则引擎自动分类旋转类型（上旋/下旋/侧旋）

### 12.3 长期愿景

- **PWA 离线缓存支持**：Service Worker 缓存网页，即使断开 WiFi 也能查看历史数据
- **蓝牙 BLE 备选通道**：在 WiFi 不可用时降级为 BLE 传输
- **云端数据同步**：连接外网时自动上传训练数据到云端
- **教练端多人监控**：一个教练端同时监控多名球员的实时旋转数据
