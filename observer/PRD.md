# 网球旋转数据观测器 — 产品需求文档

## 1. 项目概述

- **项目名称**：网球旋转数据观测器（Tennis Ball Spin Observer）
- **目标**：作为独立 Python 客户端，连接 ATOM S3 的 WebSocket 数据流，实现数据持久化存储、训练会话管理、旋转轴极坐标分析等功能
- **核心定位**：观测者 — 只读连接，不干预设备行为，专注数据采集与离线分析
- **适用场景**：教练在场边用笔记本实时记录训练数据，训练后回顾分析旋转模式
- **设计原则**：不修改任何 ATOM S3 固件代码，与现有 Web 仪表盘并行工作

---

## 2. 系统架构

```
         ATOM S3 WiFi AP (192.168.4.1)
            ┌──────────┐
            │TennisBall│
            │  _IMU    │
            │ WS :81   │
            └────┬─────┘
                 │ 192.168.4.x 子网
        ┌────────┼────────┐
        │        │        │
     笔记本    手机      (其他)
    .4.2       .4.3
        │        │
  Observer    浏览器访问
  Python      笔记本 IP
        │
   ┌────┴────┐
   │ SQLite  │←── 持久化存储
   │ 数据库  │
   └────┬────┘
        │
   ┌────┴────┐
   │ 分析    │←── http://localhost:8080
   │ 仪表盘  │    （笔记本本地 PWA）
   └─────────┘    手机访问 http://192.168.4.2:8080
```

### 工作流程

1. 笔记本电脑连接 ATOM S3 的 WiFi 热点（SSID: `TennisBall_IMU`，密码: `tennis123`）
2. 运行 `python observer.py`，自动连接 `ws://192.168.4.1:81`
3. 实时接收 50Hz IMU 数据和击球事件，批量写入 SQLite 数据库
4. 同时在 `http://localhost:8080` 启动分析仪表盘
5. 手机可通过浏览器访问笔记本 IP 的 8080 端口查看仪表盘
6. 训练结束按 Ctrl+C 停止，仪表盘仍可查看历史数据

---

## 3. 网络拓扑

所有设备连接 ATOM S3 的 WiFi 热点，处于同一 192.168.4.x 子网：

- **ATOM S3**（192.168.4.1）：WiFi AP + WebSocket 数据源
- **笔记本**（192.168.4.2）：运行 Observer 脚本 + 分析仪表盘
- **手机**（192.168.4.3）：浏览器访问笔记本的仪表盘，或直接访问 ATOM S3 的简易仪表盘
- WebSocket 最多支持 3 个客户端同时连接（ATOM S3 限制）

---

## 4. 数据存储设计

### 4.1 数据库选型

- 使用 **SQLite** 单文件数据库，Python 标准库自带，零配置
- 默认数据库文件：`tennis_data.db`（运行目录下）
- 单次 10 分钟训练（50Hz）约 3MB，一年每天练习不到 1GB

### 4.2 数据表结构

#### 训练会话表（sessions）

| 列名 | 类型 | 说明 |
|------|------|------|
| id | 自增主键 | 会话 ID |
| start_time | 文本 | 开始时间（ISO 8601 格式） |
| end_time | 文本 | 结束时间，进行中为空 |
| duration_sec | 实数 | 持续时长（秒） |
| total_samples | 整数 | 总数据包数 |
| total_shots | 整数 | 击球次数 |
| avg_rpm | 实数 | 平均转速 |
| max_rpm | 实数 | 最高转速 |
| notes | 文本 | 用户备注（可选） |

#### 原始数据表（imu_data）

| 列名 | 类型 | 说明 |
|------|------|------|
| id | 自增主键 | 数据 ID |
| session_id | 整数 | 所属会话（外键） |
| device_ts | 整数 | 设备时间戳（毫秒） |
| local_ts | 文本 | 本地接收时间 |
| ax, ay, az | 实数 | 加速度三轴（单位：g） |
| gx, gy, gz | 实数 | 陀螺仪三轴（单位：度/秒） |
| qw, qx, qy, qz | 实数 | 姿态四元数 |
| rpm | 实数 | 转速 |
| spin | 文本 | 旋转分类标签 |
| impact | 整数 | 是否击球帧（0 或 1） |

建立联合索引：(session_id, device_ts)，加速按会话和时间查询

#### 击球事件表（shots）

| 列名 | 类型 | 说明 |
|------|------|------|
| id | 自增主键 | 击球 ID |
| session_id | 整数 | 所属会话（外键） |
| shot_id | 整数 | 设备端击球序号 |
| device_ts | 整数 | 设备时间戳（毫秒） |
| local_ts | 文本 | 本地接收时间 |
| rpm | 实数 | 峰值转速 |
| peak_g | 实数 | 峰值 G 力 |
| gx, gy, gz | 实数 | 击球瞬间陀螺仪三轴 |
| spin_type | 文本 | 旋转分类 |
| spin_axis_theta | 实数 | 旋转轴极角（度） |
| spin_axis_phi | 实数 | 旋转轴方位角（度） |

极角和方位角在接收击球事件时由 Observer 端计算并存储，避免每次绘图重复计算。

### 4.3 数据写入策略

- **原始 IMU 数据**：每 100 条或每 2 秒批量写入（减少磁盘 I/O）
- **击球事件**：收到后立刻写入并提交（确保不丢失）
- **会话统计**：每 5 秒更新 sessions 表的统计字段

---

## 5. 旋转轴极坐标图

### 5.1 概述

将每次击球的旋转轴方向投影到极坐标图上，直观展示旋转轴指向。积累多次击球后，可以看出球员的习惯性旋转模式，帮助教练发现技术特征和改进方向。

### 5.2 坐标系定义

```
        上旋 (TOPSPIN)
            90°
             │
             │
  左侧旋 ────┼──── 右侧旋
  180°       │       0°
             │
             │
        下旋 (BACKSPIN)
           270°
```

- **方位角 φ**：旋转轴在水平面的投影方向。0° 为右侧旋，90° 为纯上旋，180° 为左侧旋，270° 为纯下旋
- **半径**：表示该次击球的 RPM 数值，距圆心越远转速越快
- **颜色**：按旋转分类类型着色

### 5.3 计算方法

从三轴陀螺仪数据 (gx, gy, gz) 计算旋转轴的球坐标：

1. 计算角速度幅值 ω = √(gx² + gy² + gz²)
2. 若 ω < 1.0（静止噪声），忽略该点
3. 归一化旋转轴：nx = gx/ω, ny = gy/ω, nz = gz/ω
4. 极角 θ = arccos(nz)，表示旋转轴偏离 Z 轴的角度
5. 方位角 φ = atan2(ny, nx)，转换到 0°-360° 范围

### 5.4 可视化设计

```
┌──────────────────────────────┐
│                              │
│      旋转轴极坐标图          │
│                              │
│         上旋 (90°)           │
│           ╱ ╲                │
│         ╱     ╲              │
│ 左侧旋 ── ● ●── 右侧旋     │
│  (180°)  │● ● │  (0°)       │
│          │  ●  │             │
│           ╲  ╱               │
│             ╲╱               │
│        下旋 (270°)           │
│                              │
│  ● = 单次击球（颜色=类型）   │
│  ○ = 最近一击（高亮描边）    │
│  同心圆: 50/100/150/200 RPM  │
└──────────────────────────────┘
```

#### 视觉元素

| 元素 | 说明 |
|------|------|
| 同心圆 | RPM 刻度环，灰色虚线，标注 50/100/150/200 |
| 十字线 | 穿过圆心的参考线，浅灰色 |
| 轴标签 | 上旋 / 下旋 / 左侧旋 / 右侧旋 |
| 击球点 | 实心圆，半径 6px，颜色按旋转类型 |
| 最新击球 | 白色描边 + 尺寸稍大 |

#### 配色方案

| 旋转类型 | 颜色名 | 色值 |
|----------|--------|------|
| TOPSPIN（上旋） | 珊瑚红 | #FF6B6B |
| BACKSPIN（下旋） | 青绿 | #4ECDC4 |
| SIDE_L / SIDE_R（侧旋） | 明黄 | #FFE66D |
| SLICE（切削） | 薄荷绿 | #A8E6CF |
| FLAT（平击） | 灰色 | #888888 |
| MIXED（混合） | 淡紫 | #DDA0DD |

#### 交互功能

- 鼠标悬停击球点：显示详情气泡（RPM、旋转类型、击球时间）
- 点击图例：显示/隐藏对应旋转类型的点
- 会话选择：下拉菜单切换不同训练会话

---

## 6. 分析仪表盘

### 6.1 技术选型

- 后端：Python asyncio + aiohttp（异步 HTTP + WebSocket 转发）
- 前端：单页 HTML + CSS + JavaScript + SVG（无第三方依赖）
- 端口：localhost:8080
- 笔记本本地可作为 PWA 安装（localhost 豁免 HTTPS 要求）

### 6.2 页面布局

```
┌─────────────────────────────────────────────────────────┐
│  网球旋转观测器           会话: #12 (录制中)             │
│                           ● 已录制 1523 条数据           │
├─────────────────────────────┬───────────────────────────┤
│                             │                           │
│   ┌───────────────────┐    │    训练统计                │
│   │                   │    │    ┌──────┐ ┌──────┐      │
│   │  旋转轴极坐标图   │    │    │  23  │ │  85  │      │
│   │                   │    │    │ 击球 │ │ 均RPM│      │
│   │  (SVG 400x400)    │    │    └──────┘ └──────┘      │
│   │                   │    │    ┌──────┐ ┌──────┐      │
│   │   ●  ●            │    │    │ 152  │ │ 6.8  │      │
│   │     ●   ●         │    │    │最高  │ │最大G │      │
│   │  ●    ●           │    │    │ RPM  │ │      │      │
│   │                   │    │    └──────┘ └──────┘      │
│   └───────────────────┘    │                           │
│                             │    旋转类型分布            │
│   类型筛选：                │    ┌─────────────────┐   │
│   [●上旋] [●下旋] [●侧旋]  │    │ ████ 上旋 52%   │   │
│   [●切削] [●平击]          │    │ ██   下旋 22%   │   │
│                             │    │ ███  侧旋 17%   │   │
│                             │    │ █    其他  9%   │   │
│                             │    └─────────────────┘   │
├─────────────────────────────┴───────────────────────────┤
│  击球时间线（水平可滚动）                                │
│  ●120  ●85  ●150  ●90  ●110  ●130  ●95  ●140  ●88     │
│  上旋  侧旋 上旋  下旋 切削  上旋  平击 上旋  侧旋     │
├─────────────────────────────────────────────────────────┤
│  历史会话                                               │
│  ┌────────────────────────────────────────────────────┐ │
│  │ #12  2026-02-11 15:30  录制中   23击球  均85RPM   │ │
│  │ #11  2026-02-11 14:00  12分钟   45击球  均92RPM   │ │
│  │ #10  2026-02-10 16:20   8分钟   31击球  均78RPM   │ │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
│  [导出 CSV] [导出 JSON] [删除会话]                       │
└─────────────────────────────────────────────────────────┘
```

### 6.3 功能模块

#### 实时面板

- 左侧：旋转轴极坐标图（每次击球实时添加新点）
- 右侧上方：四个统计卡片（击球数、平均 RPM、最高 RPM、最大 G 力）
- 右侧下方：旋转类型分布横向柱状图
- 下方：击球时间线，彩色标记点，点击可查看详情

#### 会话管理

- 显示所有历史训练会话，按时间倒序排列
- 每条显示：日期时间、时长、击球数、平均 RPM
- 点击会话加载该次训练的完整数据到极坐标图
- 支持删除会话（需二次确认）

#### 数据导出

- CSV 导出：原始 IMU 数据表 + 击球事件表
- JSON 导出：完整会话数据，方便程序化处理

---

## 7. 命令行功能

### 7.1 基本用法

- `python observer.py` — 连接设备并录制，同时启动仪表盘
- `python observer.py --db 文件名.db` — 指定数据库文件路径
- `python observer.py --ws ws://地址:端口` — 指定 WebSocket 地址
- `python observer.py --no-dashboard` — 仅录制，不启动仪表盘

### 7.2 终端实时状态

运行时终端持续显示：连接状态、数据库路径、仪表盘地址、当前会话编号、已采集样本数、击球次数、最近一次击球信息、平均和最高 RPM。每秒刷新一次。

### 7.3 自动重连机制

- WebSocket 断开后每 2 秒重试连接
- 断开时间 < 30 秒：重连后继续写入同一会话
- 断开时间 >= 30 秒：创建新会话

---

## 8. 技术栈

| 组件 | 选型 | 说明 |
|------|------|------|
| 运行环境 | Python >= 3.8 | 使用 asyncio 异步框架 |
| WebSocket 客户端 | websockets | 异步 WebSocket 连接库 |
| HTTP 服务器 | aiohttp | 异步 HTTP，提供仪表盘和 API |
| 数据库 | sqlite3 | Python 标准库，零额外依赖 |
| 前端渲染 | SVG + 原生 JavaScript | 无第三方库，极坐标图手写 SVG |

第三方依赖仅 2 个：`websockets` 和 `aiohttp`

---

## 9. 文件结构

```
observer/
├── PRD.md                  # 产品需求文档（本文件）
├── requirements.txt        # Python 依赖清单
├── observer.py             # 主程序入口（WebSocket 客户端 + 启动调度）
├── db.py                   # 数据库操作封装（建表、插入、查询）
├── dashboard.py            # 分析仪表盘 HTTP 服务（API + 静态文件）
├── spin_analysis.py        # 旋转轴计算（极角、方位角转换）
└── static/
    └── dashboard.html      # 仪表盘单页应用（HTML + CSS + JS + SVG）
```

---

## 10. 性能指标

| 指标 | 目标 |
|------|------|
| WebSocket 接收延迟 | < 5 毫秒 |
| 数据写入吞吐量 | 50 条/秒（匹配设备推送频率） |
| 批量写入延迟 | < 50 毫秒/批（100 条） |
| 仪表盘页面加载 | < 500 毫秒 |
| 极坐标图渲染 | < 16 毫秒/帧 |
| 单次训练存储 | 约 3MB / 10 分钟 |
| 内存占用 | < 50MB |
| 自动重连时间 | < 5 秒 |

---

## 11. WebSocket 数据协议

Observer 接收两种 JSON 消息（由 ATOM S3 固件发送，Observer 只读不写）：

### 常规数据帧（50Hz）

字段：t（时间戳）、ax/ay/az（加速度）、gx/gy/gz（陀螺仪）、qw/qx/qy/qz（四元数）、rpm（转速）、spin（旋转分类）、imp（是否击球帧）

### 击球事件帧（触发时发送）

字段：event="shot"、id（序号）、t（时间戳）、rpm（峰值转速）、peakG（峰值 G 力）、gx/gy/gz（陀螺仪）、type（旋转分类）

---

## 12. 使用流程

### 首次安装

1. 进入 observer 目录
2. 执行 `pip install -r requirements.txt` 安装依赖

### 训练录制

1. ATOM S3 上电，确认 WiFi 热点已启动
2. 笔记本连接 `TennisBall_IMU` WiFi（密码：tennis123）
3. 运行 `python observer.py`
4. 终端显示连接成功，开始自动录制
5. 浏览器打开 `http://localhost:8080` 查看分析仪表盘
6. 训练结束按 Ctrl+C 停止

### 训练后分析

1. 在仪表盘的历史会话列表中选择某次训练
2. 查看旋转轴极坐标图，分析旋转模式和一致性
3. 导出 CSV/JSON 用于进一步分析
