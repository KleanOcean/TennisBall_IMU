# YoTB 观测器 — 产品需求文档

## 1. 项目概述

- **项目名称**：YoTB 观测器（YoTB Observer — 网球旋转数据观测器）
- **品牌名称**：**YoTB**（Yoach Tennis Ball）
- **目标**：作为独立 Python 客户端，连接 ATOM S3 的 WebSocket 数据流，实现数据持久化存储、训练会话管理、旋转轴极坐标分析等功能
- **核心定位**：观测者 — 只读连接，不干预设备行为，专注数据采集与离线分析
- **视觉风格**：与 YoTB 边缘端 WebApp 共享统一的深色科技风视觉语言（荧光黄绿色线框风格）
- **适用场景**：教练在场边用笔记本实时记录训练数据，训练后回顾分析旋转模式
- **设计原则**：不修改任何 ATOM S3 固件代码，与现有 Web 仪表盘并行工作

---

## 2. 系统架构

```
         ATOM S3 WiFi AP (192.168.4.1)
            ┌──────────┐
            │TennisBall│
            │  _IMU    │
            │ WS :81   │
            └────┬─────┘
                 │ 192.168.4.x 子网
        ┌────────┼────────┐
        │        │        │
     笔记本    手机      (其他)
    .4.2       .4.3
        │        │
  Observer    浏览器访问
  Python      笔记本 IP
        │
   ┌────┴────┐
   │ SQLite  │←── 持久化存储
   │ 数据库  │
   └────┬────┘
        │
   ┌────┴────┐
   │ 分析    │←── http://localhost:8080
   │ 仪表盘  │    （笔记本本地 PWA）
   └─────────┘    手机访问 http://192.168.4.2:8080
```

### 工作流程

1. 笔记本电脑连接 ATOM S3 的 WiFi 热点（SSID: `TennisBall_IMU`，密码: `tennis123`）
2. 运行 `python observer.py`，自动连接 `ws://192.168.4.1:81`
3. 实时接收 50Hz IMU 数据和击球事件，批量写入 SQLite 数据库
4. 同时在 `http://localhost:8080` 启动分析仪表盘
5. 手机可通过浏览器访问笔记本 IP 的 8080 端口查看仪表盘
6. 训练结束按 Ctrl+C 停止，仪表盘仍可查看历史数据

---

## 3. 网络拓扑

所有设备连接 ATOM S3 的 WiFi 热点，处于同一 192.168.4.x 子网：

- **ATOM S3**（192.168.4.1）：WiFi AP + WebSocket 数据源
- **笔记本**（192.168.4.2）：运行 Observer 脚本 + 分析仪表盘
- **手机**（192.168.4.3）：浏览器访问笔记本的仪表盘，或直接访问 ATOM S3 的简易仪表盘
- WebSocket 最多支持 3 个客户端同时连接（ATOM S3 限制）

---

## 4. 数据存储设计

### 4.1 数据库选型

- 使用 **SQLite** 单文件数据库，Python 标准库自带，零配置
- 默认数据库文件：`tennis_data.db`（运行目录下）
- 单次 10 分钟训练（50Hz）约 3MB，一年每天练习不到 1GB

### 4.2 数据表结构

#### 训练会话表（sessions）

| 列名 | 类型 | 说明 |
|------|------|------|
| id | 自增主键 | 会话 ID |
| start_time | 文本 | 开始时间（ISO 8601 格式） |
| end_time | 文本 | 结束时间，进行中为空 |
| duration_sec | 实数 | 持续时长（秒） |
| total_samples | 整数 | 总数据包数 |
| total_shots | 整数 | 击球次数 |
| avg_rpm | 实数 | 平均转速 |
| max_rpm | 实数 | 最高转速 |
| notes | 文本 | 用户备注（可选） |

#### 原始数据表（imu_data）

| 列名 | 类型 | 说明 |
|------|------|------|
| id | 自增主键 | 数据 ID |
| session_id | 整数 | 所属会话（外键） |
| device_ts | 整数 | 设备时间戳（毫秒） |
| local_ts | 文本 | 本地接收时间 |
| ax, ay, az | 实数 | 加速度三轴（单位：g） |
| gx, gy, gz | 实数 | 陀螺仪三轴（单位：度/秒） |
| qw, qx, qy, qz | 实数 | 姿态四元数 |
| rpm | 实数 | 转速 |
| spin | 文本 | 旋转分类标签 |
| impact | 整数 | 是否击球帧（0 或 1） |

建立联合索引：(session_id, device_ts)，加速按会话和时间查询

#### 击球事件表（shots）

| 列名 | 类型 | 说明 |
|------|------|------|
| id | 自增主键 | 击球 ID |
| session_id | 整数 | 所属会话（外键） |
| shot_id | 整数 | 设备端击球序号 |
| device_ts | 整数 | 设备时间戳（毫秒） |
| local_ts | 文本 | 本地接收时间 |
| rpm | 实数 | 峰值转速 |
| peak_g | 实数 | 峰值 G 力 |
| gx, gy, gz | 实数 | 击球瞬间陀螺仪三轴 |
| spin_type | 文本 | 旋转分类 |
| spin_axis_theta | 实数 | 旋转轴极角（度） |
| spin_axis_phi | 实数 | 旋转轴方位角（度） |

极角和方位角在接收击球事件时由 Observer 端计算并存储，避免每次绘图重复计算。

### 4.3 数据写入策略

- **原始 IMU 数据**：每 100 条或每 2 秒批量写入（减少磁盘 I/O）
- **击球事件**：收到后立刻写入并提交（确保不丢失）
- **会话统计**：每 5 秒更新 sessions 表的统计字段

---

## 5. 旋转轴极坐标图

### 5.1 概述

将每次击球的旋转轴方向投影到极坐标图上，直观展示旋转轴指向。积累多次击球后，可以看出球员的习惯性旋转模式，帮助教练发现技术特征和改进方向。

### 5.2 坐标系定义

```
        上旋 (TOPSPIN)
            90°
             │
             │
  左侧旋 ────┼──── 右侧旋
  180°       │       0°
             │
             │
        下旋 (BACKSPIN)
           270°
```

- **方位角 φ**：旋转轴在水平面的投影方向。0° 为右侧旋，90° 为纯上旋，180° 为左侧旋，270° 为纯下旋
- **半径**：表示该次击球的 RPM 数值，距圆心越远转速越快
- **颜色**：按旋转分类类型着色

### 5.3 计算方法

从三轴陀螺仪数据 (gx, gy, gz) 计算旋转轴的球坐标：

1. 计算角速度幅值 ω = √(gx² + gy² + gz²)
2. 若 ω < 1.0（静止噪声），忽略该点
3. 归一化旋转轴：nx = gx/ω, ny = gy/ω, nz = gz/ω
4. 极角 θ = arccos(nz)，表示旋转轴偏离 Z 轴的角度
5. 方位角 φ = atan2(ny, nx)，转换到 0°-360° 范围

### 5.4 可视化设计

```
┌──────────────────────────────┐
│                              │
│      旋转轴极坐标图          │
│                              │
│         上旋 (90°)           │
│           ╱ ╲                │
│         ╱     ╲              │
│ 左侧旋 ── ● ●── 右侧旋     │
│  (180°)  │● ● │  (0°)       │
│          │  ●  │             │
│           ╲  ╱               │
│             ╲╱               │
│        下旋 (270°)           │
│                              │
│  ● = 单次击球（颜色=类型）   │
│  ○ = 最近一击（高亮描边）    │
│  同心圆: 50/100/150/200 RPM  │
└──────────────────────────────┘
```

#### 视觉元素

| 元素 | 说明 |
|------|------|
| 同心圆 | RPM 刻度环，灰色虚线，标注 50/100/150/200 |
| 十字线 | 穿过圆心的参考线，浅灰色 |
| 轴标签 | 上旋 / 下旋 / 左侧旋 / 右侧旋 |
| 击球点 | 实心圆，半径 6px，颜色按旋转类型 |
| 最新击球 | 白色描边 + 尺寸稍大 |

#### YoTB 配色方案

极坐标图整体遵循 YoTB 深色科技风视觉规范：

| 元素 | 色值 | 说明 |
|------|------|------|
| 极坐标图背景 | #0a0e27 | 极深藏青色，与页面背景一致 |
| 同心圆刻度线 | #222244 | 深灰蓝虚线 |
| 十字参考线 | #1a2040 | 极浅灰色 |
| 轴标签文字 | #667788 | 柔和蓝灰色 |
| 击球点默认辉光 | rgba(200,216,32,0.3) | 荧光黄绿色外发光 |

**旋转类型配色**（与 YoTB WebApp 统一）：

| 旋转类型 | 颜色名 | 色值 |
|----------|--------|------|
| TOPSPIN（上旋） | 珊瑚红 | #FF6B6B |
| BACKSPIN（下旋） | 青绿 | #4ECDC4 |
| SIDE_L / SIDE_R（侧旋） | 明黄 | #FFE66D |
| SLICE（切削） | 薄荷绿 | #A8E6CF |
| FLAT（平击） | 灰色 | #888888 |
| MIXED（混合） | 淡紫 | #DDA0DD |

#### 交互功能

- 鼠标悬停击球点：显示详情气泡（RPM、旋转类型、击球时间）
- 点击图例：显示/隐藏对应旋转类型的点
- 会话选择：下拉菜单切换不同训练会话

---

## 6. YoTB 分析仪表盘

### 6.1 技术选型

- 后端：Python asyncio + aiohttp（异步 HTTP + WebSocket 转发）
- 前端：单页 HTML + CSS + JavaScript + SVG（无第三方依赖）
- 端口：localhost:8080
- 笔记本本地可作为 PWA 安装（localhost 豁免 HTTPS 要求）
- 视觉规范：与 YoTB 边缘端 WebApp 共享统一品牌视觉语言

### 6.2 导航栏设计

```
┌──────────────────────────────────────────────────────────────────┐
│  YoTB    [DASHBOARD] [SHOTS] [ANALYSIS] [SETTINGS]     🔔 ●2   │
│  (粗体)   (活跃标签高亮)                             (铃铛)(设备数) │
└──────────────────────────────────────────────────────────────────┘
```

- **左上角**：品牌名 **YoTB**，粗体白色文字
- **标签页**：DASHBOARD | SHOTS | ANALYSIS | SETTINGS
  - 当前活跃标签以荧光黄绿色（#C8D820）底部边框高亮
  - 非活跃标签为灰色文字（#667788）
- **右侧**：通知铃铛图标 + 绿色连接圆点 + 已连接设备数量
- **背景色**：与页面主背景一致（#0a0e27）

### 6.3 DASHBOARD 标签页 — 桌面/平板布局（三栏）

```
┌──────────────────────────────────────────────────────────────────┐
│  YoTB    [DASHBOARD] [SHOTS] [ANALYSIS] [SETTINGS]     🔔 ●2   │
├──────────────┬──────────────────────┬────────────────────────────┤
│              │                      │                            │
│  ╭────────╮  │     ╭──────────╮     │  REAL TIME CHART           │
│  │ ╲    ╱ │  │    ╱  线框网球  ╲    │  ┌────────────────────┐    │
│  │  ╲  ╱  │  │   │   ○        │    │  │  ╱╲   ╱╲          │    │
│  │   ──   │  │   │  wireframe │    │  │ ╱  ╲ ╱  ╲  ╱╲    │    │
│  │  1850  │  │   │   seam     │    │  │╱    ╳    ╲╱  ╲   │    │
│  │  RPM   │  │   │   (glow)   │    │  └────────────────────┘    │
│  │TOPSPIN │  │    ╲          ╱     │                            │
│  ╰────────╯  │     ╰────────╯      │  SHOT TIMELINE             │
│              │                      │  ● ● ○ ● ○ ● ● ○ ●       │
│  左栏 ~25%   │    中栏 ~40%         │  右栏 ~35%                 │
└──────────────┴──────────────────────┴────────────────────────────┘
```

#### 左栏（约 25%）— RPM 半圆弧仪表

- **270° 半圆弧仪表**（从 7 点钟到 5 点钟位置扫过）
- 灰色底轨弧线（#222244）
- 荧光黄绿色（#C8D820）填充弧，长度与 RPM 数值成正比
- 弧内中央：大号粗体 RPM 数值（荧光黄绿色），如 "1850"
- 数值下方："RPM" 标签（较小字号，灰色 #667788）
- 再下方：旋转类型文字，如 "TOPSPIN"（白色文字 #FFFFFF）
- 最大 RPM 刻度可配置（默认 3000）

#### 中栏（约 40%）— 3D 线框网球（核心视觉 HERO 元素）

- Canvas 渲染的 **线框球体**，经线/纬线网格（每 30° 一条）
- 网球缝线曲线以荧光黄绿色（#C8D820）高亮渲染（更亮、更粗）
- 球体外围霓虹辉光效果：`0 0 40px rgba(200,216,32,0.3)`
- 球体保持静止（Observer 为离线分析工具，不接收实时四元数流）；**不自动旋转**
- 透视投影：远处线条更暗更细，近处更亮更粗
- Canvas 尺寸：桌面端 400x400
- 未来可根据选中击球的旋转轴方向调整球体朝向

#### 右栏（约 35%）— 实时图表 + 击球时间线

- **"REAL TIME CHART"** 标题
  - 单线折线图：角速度或 RPM 随时间滚动
  - 荧光黄绿色折线（#C8D820）
  - 深色背景（#0a0e27）
  - Y 轴灰色刻度标签，X 轴 MM:SS 时间戳
  - 网格线（#1a2040）
  - 数据窗口：最近 250 个点（约 5 秒）
- **"SHOT TIMELINE"** 标题
  - 水平排列的彩色圆点
  - 荧光黄绿色 = 击球，灰色 = 低活动
  - 支持水平滚动

### 6.4 DASHBOARD 标签页 — 移动端布局（纵向堆叠）

```
┌──────────────────────────┐
│  YoTB  [D][S][A][SET]    │  ← 紧凑标签栏
├──────────────────────────┤
│      ╭──────────╮        │
│     ╱  线框网球  ╲       │  ← 3D 线框球（较小尺寸）
│    │   wireframe │       │
│     ╲   (glow)  ╱        │
│      ╰──────────╯        │
│     1850 RPM             │  ← 大号 RPM + 旋转类型
│     TOPSPIN              │
│  ┌────────────────────┐  │
│  │  实时折线图 (小型)  │  │
│  └────────────────────┘  │
│  ● ● ○ ● ○ ● ● ○ ●     │  ← 击球时间线
└──────────────────────────┘
```

### 6.5 SHOTS 标签页（Observer 独有 — 具备会话数据）

```
┌──────────────────────────────────────────────────────────────────┐
│  YoTB    [DASHBOARD] [SHOTS] [ANALYSIS] [SETTINGS]     🔔 ●2   │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  会话历史列表                                                     │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ #12  2026-02-11 15:30  录制中    23 击球  均 85 RPM       │  │
│  │ #11  2026-02-11 14:00  12 分钟   45 击球  均 92 RPM       │  │
│  │ #10  2026-02-10 16:20   8 分钟   31 击球  均 78 RPM       │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  击球详情面板（选中某次击球后展开）                                 │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Shot #3 — TOPSPIN                                        │  │
│  │  RPM: 150  |  Peak G: 6.2  |  时间: 00:45                │  │
│  │  Gx: 120.5 |  Gy: -45.2   |  Gz: 8.1                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  [导出 CSV]  [导出 JSON]                                         │
└──────────────────────────────────────────────────────────────────┘
```

- 会话历史表格：按时间倒序排列，每行显示日期时间、时长、击球数、平均 RPM
- 点击会话展开该次训练的击球列表
- 击球详情面板：显示单次击球的完整数据
- 导出按钮：CSV / JSON 格式导出

### 6.6 ANALYSIS 标签页（Observer 独有）

```
┌──────────────────────────────────────────────────────────────────┐
│  YoTB    [DASHBOARD] [SHOTS] [ANALYSIS] [SETTINGS]     🔔 ●2   │
├─────────────────────────────┬────────────────────────────────────┤
│                             │                                    │
│  旋转轴极坐标图             │  训练统计                          │
│  ┌───────────────────┐     │  ┌──────┐ ┌──────┐                │
│  │                   │     │  │  23  │ │  85  │                │
│  │  (SVG 400x400)    │     │  │ 击球 │ │ 均RPM│                │
│  │   ●  ●            │     │  └──────┘ └──────┘                │
│  │     ●   ●         │     │  ┌──────┐ ┌──────┐                │
│  │  ●    ●           │     │  │ 152  │ │ 6.8  │                │
│  │                   │     │  │最高  │ │最大G │                │
│  └───────────────────┘     │  │ RPM  │ │      │                │
│                             │  └──────┘ └──────┘                │
│  类型筛选：                 │                                    │
│  [●上旋] [●下旋] [●侧旋]   │  旋转类型分布                      │
│  [●切削] [●平击]           │  ┌─────────────────────┐          │
│                             │  │ ████ 上旋 52%       │          │
│  会话选择: [下拉菜单 ▼]     │  │ ██   下旋 22%       │          │
│                             │  │ ███  侧旋 17%       │          │
│                             │  │ █    其他  9%       │          │
│                             │  └─────────────────────┘          │
└─────────────────────────────┴────────────────────────────────────┘
```

- **左侧**：旋转轴极坐标图（SVG 400x400，采用现有 SVG 实现）
  - 每次击球实时添加新点
  - 类型筛选按钮：按旋转类型显示/隐藏数据点
  - 会话选择下拉菜单：切换不同训练会话
- **右侧上方**：四个统计卡片（击球数、平均 RPM、最高 RPM、最大 G 力）
  - 卡片背景色 #111633，数值以荧光黄绿色（#C8D820）显示
- **右侧下方**：旋转类型分布横向柱状图
  - 柱条颜色按旋转类型配色方案

### 6.7 SETTINGS 标签页

- WiFi 信息展示（SSID、密码、IP 地址）
- 校准按钮（重置四元数）
- 录制控制（开始/停止录制）
- 数据库管理（查看数据库路径、大小）
- 删除会话按钮（需二次确认）

### 6.8 YoTB 统一配色方案

整个 Observer 仪表盘与 YoTB 边缘端 WebApp 共享统一视觉规范：

#### 基础色板

| 用途 | 色值 | 说明 |
|------|------|------|
| 页面背景 | **#0a0e27** | 极深藏青色，接近纯黑 |
| 卡片/面板背景 | **#111633** | 略浅藏青色 |
| 主强调色 | **#C8D820** | 荧光黄绿色 — RPM 数值、仪表弧、线框球、折线图 |
| 主要文字 | **#FFFFFF** | 纯白色 |
| 次要文字 | **#667788** | 柔和蓝灰色 |
| 仪表底轨 | **#222244** | 深灰蓝色 |
| 图表网格线 | **#1a2040** | 极浅深色 |
| 线框球辉光 | `0 0 40px rgba(200,216,32,0.3)` | 荧光黄绿色外发光 |

#### 视觉风格说明

- 整体 **深色科技风（Dark Tech）** 路线，与 YoTB WebApp 保持一致
- 以荧光黄绿色（#C8D820）作为唯一主强调色，统一所有关键数据可视化元素
- 统计卡片数值使用荧光黄绿色，标签使用灰色次要文字
- 极坐标图背景、同心圆刻度线等遵循同一深色色板
- 按钮采用圆角深色卡片背景 + 荧光黄绿色边框/文字

### 6.9 响应式适配

- **桌面/平板（宽度 > 768px）**：DASHBOARD 三栏并排，ANALYSIS 左右两栏
- **手机竖屏（宽度 <= 768px）**：所有内容纵向堆叠
- 断点：768px
- 移动端导航标签栏切换为紧凑模式
- 击球时间线支持水平滚动

### 6.10 功能模块总览

#### DASHBOARD 标签页（实时监控）

- 左栏：RPM 半圆弧仪表 + 旋转类型标签
- 中栏：3D 线框网球（HERO 元素），四元数驱动实时旋转
- 右栏：实时折线图 + 击球时间线

#### SHOTS 标签页（会话与击球管理）

- 会话历史列表，按时间倒序排列
- 击球详情面板，点击展开查看完整数据
- CSV / JSON 导出功能

#### ANALYSIS 标签页（旋转分析）

- 旋转轴极坐标图（SVG，每次击球实时添加新点）
- 四个统计卡片（击球数、平均 RPM、最高 RPM、最大 G 力）
- 旋转类型分布横向柱状图
- 类型筛选与会话切换

#### SETTINGS 标签页（配置与控制）

- WiFi 信息、校准、录制控制、数据库管理

---

## 7. 命令行功能

### 7.1 基本用法

- `python observer.py` — 连接设备并录制，同时启动仪表盘
- `python observer.py --db 文件名.db` — 指定数据库文件路径
- `python observer.py --ws ws://地址:端口` — 指定 WebSocket 地址
- `python observer.py --no-dashboard` — 仅录制，不启动仪表盘

### 7.2 终端实时状态

运行时终端持续显示：连接状态、数据库路径、仪表盘地址、当前会话编号、已采集样本数、击球次数、最近一次击球信息、平均和最高 RPM。每秒刷新一次。

### 7.3 自动重连机制

- WebSocket 断开后每 2 秒重试连接
- 断开时间 < 30 秒：重连后继续写入同一会话
- 断开时间 >= 30 秒：创建新会话

---

## 8. 技术栈

| 组件 | 选型 | 说明 |
|------|------|------|
| 运行环境 | Python >= 3.8 | 使用 asyncio 异步框架 |
| WebSocket 客户端 | websockets | 异步 WebSocket 连接库 |
| HTTP 服务器 | aiohttp | 异步 HTTP，提供仪表盘和 API |
| 数据库 | sqlite3 | Python 标准库，零额外依赖 |
| 前端渲染 | SVG + 原生 JavaScript | 无第三方库，极坐标图手写 SVG |

第三方依赖仅 2 个：`websockets` 和 `aiohttp`

---

## 9. 文件结构

```
observer/
├── PRD.md                  # 产品需求文档（本文件）
├── requirements.txt        # Python 依赖清单
├── observer.py             # 主程序入口（WebSocket 客户端 + 启动调度）
├── db.py                   # 数据库操作封装（建表、插入、查询）
├── dashboard.py            # 分析仪表盘 HTTP 服务（API + 静态文件）
├── spin_analysis.py        # 旋转轴计算（极角、方位角转换）
└── static/
    └── dashboard.html      # 仪表盘单页应用（HTML + CSS + JS + SVG）
```

---

## 10. 性能指标

| 指标 | 目标 |
|------|------|
| WebSocket 接收延迟 | < 5 毫秒 |
| 数据写入吞吐量 | 50 条/秒（匹配设备推送频率） |
| 批量写入延迟 | < 50 毫秒/批（100 条） |
| 仪表盘页面加载 | < 500 毫秒 |
| 极坐标图渲染 | < 16 毫秒/帧 |
| 单次训练存储 | 约 3MB / 10 分钟 |
| 内存占用 | < 50MB |
| 自动重连时间 | < 5 秒 |

---

## 11. WebSocket 数据协议

Observer 接收两种 JSON 消息（由 ATOM S3 固件发送，Observer 只读不写）：

### 常规数据帧（50Hz）

字段：t（时间戳）、ax/ay/az（加速度）、gx/gy/gz（陀螺仪）、qw/qx/qy/qz（四元数）、rpm（转速）、spin（旋转分类）、imp（是否击球帧）

### 击球事件帧（触发时发送）

字段：event="shot"、id（序号）、t（时间戳）、rpm（峰值转速）、peakG（峰值 G 力）、gx/gy/gz（陀螺仪）、type（旋转分类）

---

## 12. 使用流程

### 首次安装

1. 进入 observer 目录
2. 执行 `pip install -r requirements.txt` 安装依赖

### 训练录制

1. ATOM S3 上电，确认 WiFi 热点已启动
2. 笔记本连接 `TennisBall_IMU` WiFi（密码：tennis123）
3. 运行 `python observer.py`
4. 终端显示连接成功，开始自动录制
5. 浏览器打开 `http://localhost:8080` 查看分析仪表盘
6. 训练结束按 Ctrl+C 停止

### 训练后分析

1. 在仪表盘的历史会话列表中选择某次训练
2. 查看旋转轴极坐标图，分析旋转模式和一致性
3. 导出 CSV/JSON 用于进一步分析
