# TennisBall_IMU 产品需求文档 (PRD)

> **版本**: 1.0
> **日期**: 2026-02-12
> **状态**: 初始版本

---

## 目录

1. [项目概述](#1-项目概述)
2. [项目结构](#2-项目结构)
3. [硬件规格](#3-硬件规格)
4. [子项目1: imu_logger（IMU数据记录器）](#4-子项目1-imu_loggerimu数据记录器)
5. [子项目2: imu_visualizer（运动姿态 HUD）](#5-子项目2-imu_visualizer运动姿态-hud)
6. [技术栈](#6-技术栈)
7. [未来规划](#7-未来规划)

---

## 1. 项目概述

**TennisBall_IMU** 是一个基于 **M5Stack ATOM S3**（ESP32-S3 + MPU6886 6轴IMU）的网球运动传感项目。项目旨在利用嵌入式惯性测量单元（IMU）采集网球运动过程中的加速度和角速度数据，实现运动数据的高频记录与实时姿态可视化。

### 核心目标

- **高频数据采集**: 以 200Hz 的采样率精确记录网球运动过程中的 6 轴 IMU 数据（3 轴加速度 + 3 轴角速度）
- **冲击检测**: 实时检测网球击打/碰撞等高 G 值冲击事件
- **实时可视化**: 在设备屏幕上实时显示 IMU 姿态信息，提供直观的倾斜角度反馈
- **数据导出**: 通过串口以 CSV 格式输出数据，便于后续分析处理

### 应用场景

- 网球击球动作分析
- 球拍/球的运动轨迹研究
- 冲击力度量化评估
- 嵌入式 IMU 传感器技术验证与原型开发

---

## 2. 项目结构

本项目采用 **多项目架构**（Multi-Project Architecture），在同一仓库中包含两个独立的 PlatformIO 子项目，各自具有独立的构建配置和功能定位。

```
TennisBall_IMU/
├── PRD.md                          # 产品需求文档（本文档）
├── imu_logger/                     # 子项目1: IMU数据记录器
│   ├── platformio.ini              # PlatformIO 构建配置
│   └── src/
│       └── main.cpp                # 主程序源码
└── imu_visualizer/                 # 子项目2: 运动姿态 HUD
    ├── platformio.ini              # PlatformIO 构建配置
    └── src/
        └── main.cpp                # 主程序源码
```

### 子项目关系

| 子项目 | 功能定位 | 运行模式 |
|--------|---------|---------|
| `imu_logger` | 数据采集与记录 | 高频采样，串口CSV输出 |
| `imu_visualizer` | 运动姿态 HUD | 仿航空姿态仪，屏幕渲染 |

两个子项目共享相同的硬件平台（M5Stack ATOM S3），但各自独立编译和烧录，用户根据需求选择烧录对应的固件。

---

## 3. 硬件规格

### M5Stack ATOM S3

本项目基于 M5Stack ATOM S3 开发板，该开发板集成了高性能微控制器、6轴 IMU 传感器和小尺寸 IPS 显示屏，非常适合便携式运动传感应用。

| 参数 | 规格 |
|------|------|
| **开发板** | M5Stack ATOM S3 |
| **MCU** | ESP32-S3，双核 Xtensa LX7，主频 240MHz |
| **Flash** | 8MB |
| **PSRAM** | 8MB |
| **IMU 传感器** | MPU6886（6轴） |
| **加速度计** | 3轴，量程 ±2g / ±4g / ±8g / ±16g |
| **陀螺仪** | 3轴，量程 ±250 / ±500 / ±1000 / ±2000 dps |
| **显示屏** | 128x128 像素，GC9107 IPS 彩色屏 |
| **按钮** | BtnA（正面物理按钮） |
| **接口** | USB Type-C（供电 + 串口通信） |
| **通信** | Wi-Fi 802.11 b/g/n, Bluetooth 5.0 (LE) |
| **尺寸** | 24 x 24 x 13 mm |

### IMU 传感器说明

MPU6886 是一颗高性能 6 轴惯性测量单元，内置 3 轴加速度计和 3 轴陀螺仪：

- **加速度计**: 测量线性加速度（单位: g），用于检测运动方向、冲击力和倾斜角度
- **陀螺仪**: 测量角速度（单位: degrees per second, dps），用于检测旋转运动

---

## 4. 子项目1: imu_logger（IMU数据记录器）

### 4.1 功能描述

`imu_logger` 是一个高频 IMU 数据采集与记录程序。它以 200Hz 的采样率持续读取 MPU6886 的 6 轴数据，以标准 CSV 格式通过串口实时输出，同时具备冲击检测能力，可自动标记高 G 值冲击事件。

### 4.2 采样率

| 参数 | 值 |
|------|-----|
| **采样间隔** | 5ms |
| **采样率** | 200Hz |
| **定时方式** | 基于 `millis()` 的非阻塞定时 |

采样率设定为 200Hz，能够满足网球运动中快速冲击事件的采集需求（冲击持续时间通常在数毫秒级别）。

### 4.3 输出格式

数据通过串口（波特率 115200）以 CSV 格式输出，每行包含一个采样点的完整数据：

```
timestamp_ms,accel_x_g,accel_y_g,accel_z_g,gyro_x_dps,gyro_y_dps,gyro_z_dps,accel_mag_g,impact
```

| 字段 | 类型 | 单位 | 说明 |
|------|------|------|------|
| `timestamp_ms` | uint32 | ms | 系统时间戳（毫秒） |
| `accel_x_g` | float | g | X轴加速度 |
| `accel_y_g` | float | g | Y轴加速度 |
| `accel_z_g` | float | g | Z轴加速度 |
| `gyro_x_dps` | float | dps | X轴角速度 |
| `gyro_y_dps` | float | dps | Y轴角速度 |
| `gyro_z_dps` | float | dps | Z轴角速度 |
| `accel_mag_g` | float | g | 加速度合成矢量幅值 |
| `impact` | int | - | 冲击标志（0=正常, 1=冲击） |

数据精度：加速度保留4位小数，角速度保留2位小数。

示例输出：

```csv
timestamp_ms,accel_x_g,accel_y_g,accel_z_g,gyro_x_dps,gyro_y_dps,gyro_z_dps,accel_mag_g,impact
1234,0.0123,-0.0456,0.9987,1.23,-0.45,0.67,1.0002,0
1239,5.1234,-3.2100,7.8901,120.50,-85.30,45.20,9.8765,1
```

### 4.4 冲击检测

| 参数 | 值 |
|------|-----|
| **检测阈值** | 8g |
| **检测方法** | 加速度合成矢量幅值判定 |

冲击检测算法：

```
加速度幅值 = √(ax² + ay² + az²)
当 加速度幅值 > 8g 时，标记为冲击事件（impact = 1）
```

当检测到冲击时：
- CSV 数据中 `impact` 字段标记为 `1`
- 屏幕背景变为红色，提供视觉提示
- 系统记录并更新峰值加速度（Peak Acceleration）

### 4.5 按钮控制

BtnA 按钮用于控制录制的开启和暂停：

| 操作 | 功能 | 屏幕反馈 | 串口反馈 |
|------|------|---------|---------|
| 按下 BtnA（录制中） | 暂停录制 | 屏幕变蓝，显示 "PAUSED" | 输出 `# RECORDING PAUSED` |
| 按下 BtnA（暂停中） | 恢复录制 | 屏幕变黑，显示 "REC ON" | 输出 `# RECORDING RESUMED` |

初始状态为录制开启。

### 4.6 屏幕显示

屏幕每 500ms 更新一次（每 100 个采样点刷新），显示以下信息：

- **Acc**: 当前加速度幅值（单位: g）
- **Pk**: 峰值加速度（单位: g）
- **Gx / Gy**: X/Y 轴角速度
- **N**: 累计采样点数

---

## 5. 子项目2: imu_visualizer（运动姿态 HUD）

### 5.1 设计理念

仿航空姿态仪 + 运动科技美学，在 128x128 小屏上实现专业级运动姿态显示。`imu_visualizer` 是一个"运动姿态 HUD"（Sport Motion HUD），灵感来自航空姿态指示器，融合运动科技美学，通过加速度计数据实时计算设备的俯仰角（Pitch）和横滚角（Roll），以 HUD 风格直观展示设备姿态。

### 5.2 UI 层次（从后到前）

界面采用多层叠加架构，在 128x128 屏幕上从后到前依次渲染以下视觉层：

#### 层1: 人工地平线（Artificial Horizon） — 全屏背景

- **天空层**: 深海军蓝（#08142E）
- **地面层**: 深琥珀色（#281808）
- **地平线**: 明亮青色（Cyan），1px
- 随 Roll 倾斜旋转，随 Pitch 上下平移
- 使用三角形填充算法，支持任意角度

#### 层2: 俯仰刻度线（Pitch Ladder）

- ±10°、±20° 短横线，随地平线旋转
- 灰色细线，20° 刻度比 10° 稍长
- 提供角度参考尺度

#### 层3: 固定准星（Center Reticle） — HUD 风格

- 中心圆点 + 两侧水平翼 + 翼端下折
- 颜色动态变化：
  - **白色**: 倾斜 >3°
  - **青色**: 倾斜 1°~3°
  - **运动绿**: 倾斜 <1°（水平状态）

#### 层4: 零滚转指示三角 — 屏幕顶部中心

- 固定的向下小三角，标记零滚转位置
- 地平线在其下方旋转，直观显示滚转角度

#### 层5: G力指示条（G-Force Bar） — 右侧边缘

- 3px 宽竖条，全高
- 显示加速度合力大小
- 颜色分级：绿色 <1.5g，黄色 1.5-3g，红色 >3g
- 1g 参考线标记
- 适用于运动冲击检测

#### 层6: 数字叠加层

- **左上角**: 总倾斜角（大字号 + 黑色阴影，增强可读性）
- **右上角**: 当前 G 力值
- **底部**: P（俯仰）/ R（横滚）精确数值

### 5.3 核心算法

#### 5.3.1 姿态计算（atan2）

通过加速度计数据使用 `atan2` 函数计算俯仰角和横滚角：

```
Pitch = atan2(-ax, √(ay² + az²)) × 180° / π
Roll  = atan2(ay, √(ax² + az²)) × 180° / π
```

其中 `ax`, `ay`, `az` 为三轴加速度值（单位: g）。该算法在静态或缓慢运动条件下能够提供稳定的姿态估计。

#### 5.3.2 低通滤波（alpha=0.15）

采用一阶指数移动平均（EMA）低通滤波器，平滑 IMU 原始数据中的噪声：

```
filtPitch += 0.15 × (rawPitch - filtPitch)
filtRoll  += 0.15 × (rawRoll  - filtRoll)
```

| 参数 | 值 | 说明 |
|------|-----|------|
| **滤波系数 (α)** | 0.15 | 较小的 α 值提供更强的平滑效果 |
| **响应特性** | 低通 | 抑制高频噪声，保留低频姿态变化 |
| **截止频率** | 约 0.8Hz（在 30fps 下） | 适合缓慢的倾斜运动检测 |

#### 5.3.3 地平线渲染

采用三角形填充法，计算旋转后的天地分界多边形：

- 根据 Roll 角度旋转地平线
- 根据 Pitch 角度沿法线方向平移地平线
- 将屏幕划分为天空和地面两个多边形区域
- 分别以对应颜色填充

#### 5.3.4 俯仰刻度渲染

- 沿地平线法线方向偏移对应角度距离
- 随地平线一同旋转
- ±10° 和 ±20° 刻度线长度不同，提供视觉层次

#### 5.3.5 总倾斜角度计算

```
总角度 = √(Pitch² + Roll²)
```

该值用于左上角的角度显示，同时决定准星颜色。

### 5.4 色彩方案（RGB565）

| 元素 | 颜色值 | 说明 |
|------|--------|------|
| 天空 | 0x08A6 | 深海军蓝 |
| 地面 | 0x28C1 | 深琥珀色 |
| 地平线 | 0x07FF | 青色 |
| 准星 | 动态 | 白/青/绿（根据倾斜角度） |
| G力条 | 分级 | 绿/黄/红（根据G力大小） |
| 文字 | 0xFFFF | 白色 + 黑色阴影 |

### 5.5 按钮校准功能

按下 BtnA 按钮可执行零点校准，将当前姿态设定为参考零位：

| 操作 | 功能 |
|------|------|
| 按下 BtnA | 校准当前姿态为零点 |
| 校准效果 | 后续所有角度读数减去偏移量，当前姿态显示为 0° |
| 应用场景 | 补偿安装角度偏差，设定自定义参考平面 |

### 5.6 双缓冲渲染 ~30fps

程序采用 M5Canvas 实现离屏双缓冲渲染，避免画面撕裂和闪烁：

| 参数 | 值 |
|------|-----|
| **渲染方式** | M5Canvas Sprite 离屏渲染 → pushSprite |
| **帧率** | ~30fps（33ms/帧） |
| **缓冲区大小** | 128 × 128 × 2 bytes = 32KB（16位色） |
| **渲染流程** | 填充人工地平线 → 绘制俯仰刻度 → 绘制准星 → 绘制零滚转三角 → 绘制G力条 → 绘制数字叠加层 → pushSprite 一次性推送 |

---

## 6. 技术栈

### 6.1 开发环境

| 组件 | 版本/说明 |
|------|---------|
| **构建系统** | PlatformIO |
| **开发框架** | Arduino Framework |
| **目标平台** | Espressif32 (ESP32-S3) |
| **开发板定义** | m5stack-atoms3 |

### 6.2 核心依赖库

| 库名 | 版本 | 说明 |
|------|------|------|
| **M5Unified** | ≥ 0.1.16 | M5Stack 统一驱动库，提供 IMU、显示屏、按钮等硬件抽象 |

M5Unified 库是 M5Stack 官方推出的统一硬件抽象库，整合了以下功能模块：

- **IMU 驱动**: 自动识别并初始化 MPU6886 传感器，提供标准化的数据读取接口
- **显示驱动**: 支持 GC9107 等多种屏幕控制器，提供 TFT 图形绘制 API
- **按钮管理**: 封装物理按钮的去抖和事件检测（wasPressed / wasReleased 等）
- **M5Canvas**: 离屏 Sprite 渲染引擎，支持双缓冲和丰富的图形原语

### 6.3 串口配置

| 参数 | 值 |
|------|-----|
| **波特率** | 115200 bps |
| **烧录速度** | 1500000 bps |

### 6.4 编程语言

- **C++ (Arduino)**: 主要编程语言，基于 Arduino 框架的 C++ 子集
- **标准库依赖**: `<math.h>`（数学运算: `sqrtf`, `atan2f`, `M_PI` 等）

---

## 7. 未来规划

以下为 TennisBall_IMU 项目可能的扩展方向和功能迭代计划：

### 7.1 网球运动分析

- **击球类型识别**: 基于 IMU 数据模式，利用阈值判定或机器学习算法自动识别正手、反手、发球等击球类型
- **击球力度评估**: 通过冲击峰值加速度和持续时间量化击球力度
- **挥拍轨迹重建**: 利用陀螺仪数据积分重建挥拍运动轨迹
- **击球频率统计**: 自动统计单位时间内的击球次数和间隔

### 7.2 数据存储到 SD 卡

- **本地数据持久化**: 将 CSV 数据直接写入 SD 卡/SPIFFS，支持长时间无线录制
- **文件管理**: 按时间戳自动创建数据文件，支持多次录制会话
- **存储容量管理**: 自动检测剩余空间，防止数据丢失

### 7.3 蓝牙传输

- **BLE 实时传输**: 通过 ESP32-S3 内置 Bluetooth 5.0 LE 将 IMU 数据实时传输至手机或电脑
- **手机 App 配套**: 开发配套移动端应用，实现远程数据查看和分析
- **无线校准**: 通过蓝牙远程触发校准和配置参数修改

### 7.4 Wi-Fi 数据上传

- **云端数据同步**: 通过 Wi-Fi 将数据上传至云服务器进行存储和分析
- **Web 仪表盘**: 提供基于浏览器的实时数据可视化仪表盘
- **OTA 固件更新**: 支持通过 Wi-Fi 进行无线固件升级

### 7.5 高级传感器融合

- **互补滤波器**: 融合加速度计和陀螺仪数据，提升姿态估计精度
- **Madgwick/Mahony 滤波**: 引入更先进的姿态估计算法
- **温度补偿**: 利用 MPU6886 内置温度传感器进行温漂补偿

### 7.6 运动轨迹回放

- **轨迹记录**: 持续记录 IMU 姿态数据序列，存储运动过程
- **回放功能**: 在屏幕上回放历史运动轨迹，支持慢放和快进
- **关键帧标记**: 自动标记冲击事件和姿态突变点，便于分析

### 7.7 多设备蓝牙同步

- **多节点组网**: 通过 BLE 实现多个 ATOM S3 设备之间的数据同步
- **分布式采集**: 在球拍、手腕、手臂等不同部位同时采集，构建完整运动链
- **时间同步**: 设备间精确时间对齐，确保多通道数据一致性

### 7.8 振动反馈

- **目标角度触发**: 当设备姿态达到预设目标角度时，触发振动提醒
- **训练辅助**: 帮助运动员建立正确的击球角度肌肉记忆
- **多级振动模式**: 根据偏离目标角度的程度，提供不同强度的振动反馈

---

> **文档维护说明**: 本文档应随项目迭代持续更新，确保需求描述与实际实现保持一致。
